<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>More Instant Messaging Interoperability (MIMI) using HTTPS and MLS</title>
<meta content="Travis Ralston" name="author">
<meta content="Konrad Kohbrok" name="author">
<meta content="Raphael Robert" name="author">
<meta content="Matthew Hodgson" name="author">
<meta content="
       This document specifies the More Instant Messaging Interoperability (MIMI)
protocol, which allows users of different messaging providers to share
membership in rooms and send messages to one-another. 
       More specifically, the MIMI protocol defines message formats and conventions
that allows the servers of different providers to interoperate, leaving the
provider-internal client-server communication up to the provider. 
       To ensure that communications between users are confidential and authentic, the
MIMI protocol relies on MLS ( , through the MIMI DS protocol
 ) to protect messages end-to-end. 
    " name="description">
<meta content="xml2rfc 3.19.1" name="generator">
<meta content="mimi" name="keyword">
<meta content="interoperable messaging" name="keyword">
<meta content="chat" name="keyword">
<meta content="secure messaging" name="keyword">
<meta content="draft-ralston-mimi-protocol-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.19.1
    Python 3.11.6
    ConfigArgParse 1.7
    google-i18n-address 3.1.0
    intervaltree 3.1.0
    Jinja2 3.1.2
    lxml 4.9.3
    platformdirs 4.1.0
    pycountry 22.3.5
    PyYAML 6.0.1
    requests 2.31.0
    setuptools 68.2.2
    six 1.16.0
    wcwidth 0.2.13
-->
<link href="draft-ralston-mimi-protocol.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
:is(ol, ul) :is(ol, ul) {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  line-height: 1;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
}
dl.olPercent {
  --indent: 5ch;
}
dl > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl.dlNewline > dt {
  float: none;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
dl.olPercent > dt {
  min-width: calc(var(--indent) - 2ch);
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:first-child, .break:first-child + *) {
  margin-top: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:last-child) {
  margin-bottom: 0;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0;
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    overflow-x: auto;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
}
a.pilcrow[href] { color: var(--pilcrow-weak); }
a.pilcrow[href]:hover { text-decoration: none; }
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
}
#identifiers dt {
  width: var(--identifier-width);
  min-width: var(--identifier-width);
  clear: left;
  float: left;
  text-align: right;
  margin-right: 1ch;
}
#identifiers dd {
  margin: 0;
  margin-left: calc(1em + var(--identifier-width)) !important;
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 2px 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 10ch;
  margin-right: 1.5ch;
}
.references dt:target::before {
  content: "⇒";
  width: 15px;
  margin: 0 10px 0 -25px;
}
.references dd {
  margin-left: 12ch !important;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 1px 0 0 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul :is(p, li) {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre, .vcard {
    page-break-inside: avoid;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  :is(h2, h3, h4, h5, h6)+*, dd {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
  .toplink {
    display: none;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Provide styling for table cell text alignment */
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">MIMI+MLS Protocol</td>
<td class="right">January 2024</td>
</tr></thead>
<tfoot><tr>
<td class="left">Ralston, et al.</td>
<td class="center">Expires 3 August 2024</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">More Instant Messaging Interoperability</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ralston-mimi-protocol-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2024-01-31" class="published">31 January 2024</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2024-08-03">3 August 2024</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">T. Ralston</div>
<div class="org">The Matrix.org Foundation C.I.C.</div>
</div>
<div class="author">
      <div class="author-name">K. Kohbrok</div>
<div class="org">Phoenix R&amp;D</div>
</div>
<div class="author">
      <div class="author-name">R. Robert</div>
<div class="org">Phoenix R&amp;D</div>
</div>
<div class="author">
      <div class="author-name">M. Hodgson</div>
<div class="org">The Matrix.org Foundation C.I.C.</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">More Instant Messaging Interoperability (MIMI) using HTTPS and MLS</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document specifies the More Instant Messaging Interoperability (MIMI)
protocol, which allows users of different messaging providers to share
membership in rooms and send messages to one-another.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
<p id="section-abstract-2">More specifically, the MIMI protocol defines message formats and conventions
that allows the servers of different providers to interoperate, leaving the
provider-internal client-server communication up to the provider.<a href="#section-abstract-2" class="pilcrow">¶</a></p>
<p id="section-abstract-3">To ensure that communications between users are confidential and authentic, the
MIMI protocol relies on MLS (<span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span>, through the MIMI DS protocol
<span>[<a href="#I-D.robert-mimi-delivery-service" class="cite xref">I-D.robert-mimi-delivery-service</a>]</span>) to protect messages end-to-end.<a href="#section-abstract-3" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-about-this-document">
<a href="#name-about-this-document" class="section-name selfRef">About This Document</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">
        The latest revision of this draft can be found at <span><a href="https://bifurcation.github.io/ietf-mimi-protocol/draft-ralston-mimi-protocol.html">https://bifurcation.github.io/ietf-mimi-protocol/draft-ralston-mimi-protocol.html</a></span>.
        Status information for this document may be found at <span><a href="https://datatracker.ietf.org/doc/draft-ralston-mimi-protocol/">https://datatracker.ietf.org/doc/draft-ralston-mimi-protocol/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">
        Discussion of this document takes place on the
        More Instant Messaging Interoperability Working Group mailing list (<span><a href="mailto:mimi@ietf.org">mailto:mimi@ietf.org</a></span>),
        which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/mimi/">https://mailarchive.ietf.org/arch/browse/mimi/</a></span>.
        Subscribe at <span><a href="https://www.ietf.org/mailman/listinfo/mimi/">https://www.ietf.org/mailman/listinfo/mimi/</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
<p id="section-note.1-4">Source for this draft and an issue tracker can be found at
        <span><a href="https://github.com/bifurcation/ietf-mimi-protocol">https://github.com/bifurcation/ietf-mimi-protocol</a></span>.<a href="#section-note.1-4" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 3 August 2024.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2024 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="auto internal xref">1.1</a>.  <a href="#name-known-gaps" class="internal xref">Known Gaps</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-conventions-and-definitions" class="internal xref">Conventions and Definitions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-example-protocol-flow" class="internal xref">Example protocol flow</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-get-internal-identifier-for" class="internal xref">Get internal identifier for Bob</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-fetch-initial-key-material-" class="internal xref">Fetch initial key material for Bob</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="auto internal xref">3.3</a>.  <a href="#name-create-a-room" class="internal xref">Create a room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.4">
                <p id="section-toc.1-1.3.2.4.1"><a href="#section-3.4" class="auto internal xref">3.4</a>.  <a href="#name-alice-adds-bob" class="internal xref">Alice adds Bob</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5">
                <p id="section-toc.1-1.3.2.5.1"><a href="#section-3.5" class="auto internal xref">3.5</a>.  <a href="#name-alice-sends-a-message-to-th" class="internal xref">Alice sends a message to the room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.6">
                <p id="section-toc.1-1.3.2.6.1"><a href="#section-3.6" class="auto internal xref">3.6</a>.  <a href="#name-the-hub-owning-provider-fan" class="internal xref">The hub/owning provider fans out the message</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.7">
                <p id="section-toc.1-1.3.2.7.1"><a href="#section-3.7" class="auto internal xref">3.7</a>.  <a href="#name-bob-sends-a-message-to-the-" class="internal xref">Bob sends a message to the room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.8">
                <p id="section-toc.1-1.3.2.8.1"><a href="#section-3.8" class="auto internal xref">3.8</a>.  <a href="#name-bob-adds-a-new-client" class="internal xref">Bob adds a new client</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.9">
                <p id="section-toc.1-1.3.2.9.1"><a href="#section-3.9" class="auto internal xref">3.9</a>.  <a href="#name-alice-adds-cathy" class="internal xref">Alice adds Cathy</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.10">
                <p id="section-toc.1-1.3.2.10.1"><a href="#section-3.10" class="auto internal xref">3.10</a>. <a href="#name-alice-removes-bob-from-the-" class="internal xref">Alice removes Bob from the room</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-framing" class="internal xref">Framing</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-rooms-and-events" class="internal xref">Rooms and Events</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="auto internal xref">5.1</a>.  <a href="#name-event-schema" class="internal xref">Event Schema</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="auto internal xref">5.2</a>.  <a href="#name-room-state" class="internal xref">Room state</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.3">
                <p id="section-toc.1-1.5.2.3.1"><a href="#section-5.3" class="auto internal xref">5.3</a>.  <a href="#name-cryptographic-room-represen" class="internal xref">Cryptographic room representation</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.3.2.1">
                    <p id="section-toc.1-1.5.2.3.2.1.1"><a href="#section-5.3.1" class="auto internal xref">5.3.1</a>.  <a href="#name-proposal-commit-paradigm" class="internal xref">Proposal-commit paradigm</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.3.2.2">
                    <p id="section-toc.1-1.5.2.3.2.2.1"><a href="#section-5.3.2" class="auto internal xref">5.3.2</a>.  <a href="#name-cryptographically-anchoring" class="internal xref">Cryptographically anchoring room state</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.3.2.3">
                    <p id="section-toc.1-1.5.2.3.2.3.1"><a href="#section-5.3.3" class="auto internal xref">5.3.3</a>.  <a href="#name-authenticating-proposals" class="internal xref">Authenticating proposals</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.3.2.4">
                    <p id="section-toc.1-1.5.2.3.2.4.1"><a href="#section-5.3.4" class="auto internal xref">5.3.4</a>.  <a href="#name-mimi-ds-events" class="internal xref">MIMI DS events</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.4">
                <p id="section-toc.1-1.5.2.4.1"><a href="#section-5.4" class="auto internal xref">5.4</a>.  <a href="#name-creation" class="internal xref">Creation</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.4.2.1">
                    <p id="section-toc.1-1.5.2.4.2.1.1"><a href="#section-5.4.1" class="auto internal xref">5.4.1</a>.  <a href="#name-mroominfo" class="internal xref"><code>m.room.info</code></a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-user-participation-and-clie" class="internal xref">User Participation and Client Membership</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="auto internal xref">6.1</a>.  <a href="#name-adds" class="internal xref">Adds</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="auto internal xref">6.2</a>.  <a href="#name-invites" class="internal xref">Invites</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3">
                <p id="section-toc.1-1.6.2.3.1"><a href="#section-6.3" class="auto internal xref">6.3</a>.  <a href="#name-joins" class="internal xref">Joins</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4">
                <p id="section-toc.1-1.6.2.4.1"><a href="#section-6.4" class="auto internal xref">6.4</a>.  <a href="#name-leaves-kicks" class="internal xref">Leaves/Kicks</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.5">
                <p id="section-toc.1-1.6.2.5.1"><a href="#section-6.5" class="auto internal xref">6.5</a>.  <a href="#name-bans" class="internal xref">Bans</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.6">
                <p id="section-toc.1-1.6.2.6.1"><a href="#section-6.6" class="auto internal xref">6.6</a>.  <a href="#name-knocks" class="internal xref">Knocks</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.7">
                <p id="section-toc.1-1.6.2.7.1"><a href="#section-6.7" class="auto internal xref">6.7</a>.  <a href="#name-mroomuser" class="internal xref"><code>m.room.user</code></a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-transport" class="internal xref">Transport</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1" class="auto internal xref">7.1</a>.  <a href="#name-authentication" class="internal xref">Authentication</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2" class="auto internal xref">7.2</a>.  <a href="#name-endpoint-discovery" class="internal xref">Endpoint Discovery</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.3">
                <p id="section-toc.1-1.7.2.3.1"><a href="#section-7.3" class="auto internal xref">7.3</a>.  <a href="#name-rest-endpoints" class="internal xref">REST Endpoints</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.3.2.1">
                    <p id="section-toc.1-1.7.2.3.2.1.1"><a href="#section-7.3.1" class="auto internal xref">7.3.1</a>.  <a href="#name-send-event" class="internal xref">Send Event</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.3.2.2">
                    <p id="section-toc.1-1.7.2.3.2.2.1"><a href="#section-7.3.2" class="auto internal xref">7.3.2</a>.  <a href="#name-check-invite-event" class="internal xref">Check Invite Event</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a href="#section-9.1" class="auto internal xref">9.1</a>.  <a href="#name-mimi-event-types" class="internal xref">MIMI Event Types</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="auto internal xref">10</a>. <a href="#name-references" class="internal xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.1">
                <p id="section-toc.1-1.10.2.1.1"><a href="#section-10.1" class="auto internal xref">10.1</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.2">
                <p id="section-toc.1-1.10.2.2.1"><a href="#section-10.2" class="auto internal xref">10.2</a>.  <a href="#name-informative-references" class="internal xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-acknowledgments" class="internal xref">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-contributors" class="internal xref">Contributors</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#appendix-C" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">The More Instant Messaging Interoperability (MIMI) transport protocol enables providers of
end-to-end encrypted instant messaging to interoperate. As described in the MIMI
architecture <span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>, group chats and direct messages are
described in terms of "rooms".  Each MIMI protocol room is hosted at a single
provider (the "hub" provider"), but allows users from different providers to
become participants in the room. The hub provider is responsible for ordering
and distributing messages, enforcing policy, and authorizing messages. It also
keeps a copy of the room state, which includes the room policy and participant
list, which it can provide to new joiners. Each provider also
stores initial keying material and consent for its own users (who may be offline).<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">This document describes the communication among different providers necessary to
support messaging application functionality, for example:<a href="#section-1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1-3.1">
          <p id="section-1-3.1.1">Sharing room policy<a href="#section-1-3.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-1-3.2">
          <p id="section-1-3.2.1">Adding and removing participants in a room<a href="#section-1-3.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-1-3.3">
          <p id="section-1-3.3.1">Exchanging secure messages<a href="#section-1-3.3.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-1-4">In support of these functions, the protocol also has primitives to fetch initial
keying material, fetch the current state of the underlying end-to-end encryption
protocol for the room, and request, grant, and reject consent to communicate
with users on other providers.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">Messages sent inside each room are end-to-end encrypted using the Messaging
Layer Security (MLS) protocol <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span>, and each room is associated with an
MLS group. MLS also ensures that clients in a room agree on the room policy and
participation.  MLS is integrated into MIMI in such a way as to ensure that a
client is joined to a room's MLS group only if the client's user is a
participant in the room, and that all clients in the group agree on the state
of the room (including, for example, the room's participant list).<a href="#section-1-5" class="pilcrow">¶</a></p>
<div id="known-gaps">
<section id="section-1.1">
        <h3 id="name-known-gaps">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-known-gaps" class="section-name selfRef">Known Gaps</a>
        </h3>
<p id="section-1.1-1">In this version of the document, we have tried to capture enough concrete
functionality to enable basic application functionality, while defining enough
of a protocol framework to indicate how to add other necessary functionality.  The
following functions are likely to be needed by the complete protocol, but are
not covered here:<a href="#section-1.1-1" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-1.1-2">
          <dt id="section-1.1-2.1">Authorization policy:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.2">
            <p id="section-1.1-2.2.1">In this document, we assume that all participants in a room have equal
capability.  Actual messaging systems have authorization policies for which
clients can take which actions in a room.<a href="#section-1.1-2.2.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.3">Advanced join/leave flows:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.4">
            <p id="section-1.1-2.4.1">In this document, all adds / removes / joins / leaves are initiated from
within the group, since this aligns well with MLS.  Messaging application
support a variety of other flows, some of which this protocol will need to
support.<a href="#section-1.1-2.4.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.5">Consent:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.6">
            <p id="section-1.1-2.6.1">In this document, we assume that any required consent has already been
obtained, e.g., a user consenting to be added to a room by another user.  The
full protocol will need some mechanisms for establishing this consent.<a href="#section-1.1-2.6.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.7">Identifiers:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.8">
            <p id="section-1.1-2.8.1">Certain entities in the MIMI system need to be identified in the protocol.  In
this document, we define a notional syntax for identifiers, but a more
concrete one should be defined.<a href="#section-1.1-2.8.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.9">Abuse reporting:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.10">
            <p id="section-1.1-2.10.1">There is no mechanism in this document for reporting abusive behavior to a
messaging provider.<a href="#section-1.1-2.10.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.11">Identifier resolution:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.12">
            <p id="section-1.1-2.12.1">In some cases, the identifier used to initiate communications with a user
might be different from the identifier that should be used internally.  For
example, a user-visible handle might need to be mapped to a durable internal
identifier.  This document provides no mechanism for such resolution.<a href="#section-1.1-2.12.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.13">Authentication</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.14">
            <p id="section-1.1-2.14.1">While MLS provides basic message authentication, users should also be able to (cryptographically) tie the identity of other users to their respective providers. Further authentication such as tying clients to their users (or the user's other clients) may also be desirable.<a href="#section-1.1-2.14.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
</dl>
</section>
</div>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
"<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="cite xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-2-1" class="pilcrow">¶</a></p>
<p id="section-2-2">Terms and definitions are inherited from <span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>.<a href="#section-2-2" class="pilcrow">¶</a></p>
<p id="section-2-3">Throughout this document, the examples use the TLS Presentation Language
<span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span> and the semantics of HTTP <span>[<a href="#RFC7231" class="cite xref">RFC7231</a>]</span> respectively as
placeholder a set of binary encoding mechanism and transport semantics.<a href="#section-2-3" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-2-4.1">
          <p id="section-2-4.1.1"><strong>ISSUE</strong>: Come to consensus on a specific binary encoding for the MIMI
transport protocol.<a href="#section-2-4.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-2-5.1">
          <p id="section-2-5.1.1"><strong>ISSUE</strong>: Come to consensus on a specific set of MIMI transport protocol
semantics.<a href="#section-2-5.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="example-protocol-flow">
<section id="section-3">
      <h2 id="name-example-protocol-flow">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-example-protocol-flow" class="section-name selfRef">Example protocol flow</a>
      </h2>
<p id="section-3-1">This section shows how three users (Alice, Bob and Cathy) from different
providers can use the protocol specified in this document to join the same room
and send messages to one-another. (Not all of these steps are part of the MIMI
transport protocol):<a href="#section-3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-2.1">
          <p id="section-3-2.1.1">Alice get the internal identifier for Bob<a href="#section-3-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.2">
          <p id="section-3-2.2.1">Alice gains consent to talk to Bob<a href="#section-3-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.3">
          <p id="section-3-2.3.1">Alice fetches initial keying material for Bob's clients<a href="#section-3-2.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.4">
          <p id="section-3-2.4.1">(Alice create a room) †<a href="#section-3-2.4.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.5">
          <p id="section-3-2.5.1">Alice adds Bob to a room<a href="#section-3-2.5.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.6">
          <p id="section-3-2.6.1">Alice sends a message to the room<a href="#section-3-2.6.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.7">
          <p id="section-3-2.7.1">Bob sends a message to the room<a href="#section-3-2.7.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.8">
          <p id="section-3-2.8.1">The hub/owning provider fans out the message<a href="#section-3-2.8.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.9">
          <p id="section-3-2.9.1">Bob adds a new client<a href="#section-3-2.9.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.10">
          <p id="section-3-2.10.1">Alice repeats the first three steps for Cathy<a href="#section-3-2.10.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.11">
          <p id="section-3-2.11.1">Alice adds Cathy to the room<a href="#section-3-2.11.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.12">
          <p id="section-3-2.12.1">Alice removes Bob from the room<a href="#section-3-2.12.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-3-3">Throughout this section, we will detail the individual operations through
Alice's lens. All actions by Alice are taken through Alice's client and her
server's proprietary API. While some parts of the individual messages originate
from Alice's clients, the MIMI protocol is only concerned with the communication
between Alice's, Bob's and Cathy's servers. So whenever users are referenced
throughout this section, it is implied that they are communicating with their
respective servers, which then communicate with one-another.<a href="#section-3-3" class="pilcrow">¶</a></p>
<p id="section-3-4">† as mentioned in the text, creating a room is a local provider
action, which is out of scope of MIMI.<a href="#section-3-4" class="pilcrow">¶</a></p>
<div id="get-internal-identifier-for-bob">
<section id="section-3.1">
        <h3 id="name-get-internal-identifier-for">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-get-internal-identifier-for" class="section-name selfRef">Get internal identifier for Bob</a>
        </h3>
<p id="section-3.1-1">This is an example/placeholder for a possibly more sophisticated discovery
mechanism. It is not intended to be directly implemented.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.1-2.1">
            <p id="section-3.1-2.1.1"><strong>TODO</strong>: Replace with or reference a discovery mechanism with WG consensus<a href="#section-3.1-2.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.1-3.1">
            <p id="section-3.1-3.1.1"><strong>TODO</strong>: Details will follow once the WG has concensus on identifiers, their
mapping and their retrieval/discovery. The format of specific identifiers is
discussed in <span>[<a href="#I-D.mahy-mimi-identity" class="cite xref">I-D.mahy-mimi-identity</a>]</span>. Any specific conventions which are
needed should be merged into this document.<a href="#section-3.1-3.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.1-4">Alice obtains Bob's internal identifier.<a href="#section-3.1-4" class="pilcrow">¶</a></p>
<p id="section-3.1-5">Alice fetches the internal identifier for some field of Bob's, in
this example his handle.<a href="#section-3.1-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.1-6">
<pre>
GET /identifierDiscovery/{domain}
</pre><a href="#section-3.1-6" class="pilcrow">¶</a>
</div>
<p id="section-3.1-7">The request body is described as:<a href="#section-3.1-7" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-3.1-8">
<pre>
enum {
  reserved(0),
  handle(1),
  nick(2),
  email(3),
  phone(4),
  partialName(5),
  wholeProfile(6),
  oidcStdClaim(7),
  vcardField(8),
  (255)
} IdentifierType;

struct {
  IdentifierType type;
  string searchValue;
  select(type) {
     case oidcStdClaim:
       string claimName;
    case vcardField:
       string fieldName;
  };
} IdentifierRequest;

</pre><a href="#section-3.1-8" class="pilcrow">¶</a>
</div>
<p id="section-3.1-9">The response body is described as:<a href="#section-3.1-9" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-3.1-10">
<pre>
enum {
  success(0),
  notFound(1),
  ambiguous(2),
  forbidden(3),
  unsupportedField(4),
  (255)
} IdentifierDiscoveryCode;

struct {
  IdentifierDiscoverCode responseCode;
  IdentifierUri uri;
} IdentifierResponse;
</pre><a href="#section-3.1-10" class="pilcrow">¶</a>
</div>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.1-11.1">
            <p id="section-3.1-11.1.1"><strong>ISSUE</strong>: In the course of discovering Bob, Alice might or might not
obtain a list of Bob's clients.<a href="#section-3.1-11.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="fetch-initial-key-material-for-bob">
<section id="section-3.2">
        <h3 id="name-fetch-initial-key-material-">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-fetch-initial-key-material-" class="section-name selfRef">Fetch initial key material for Bob</a>
        </h3>
<p id="section-3.2-1">The action attempts to claim initial keying material for all the clients
of a list of users at a single provider. The keying material may not be
reused unless identified as "last resort" keying material.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">Alice sends an Event (framed in a MIMIMessage) of type <code>ds.fetch_key_packages</code>
to Bob's server, requesting key material for each of Bob's clients.<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<p id="section-3.2-3">See <a href="#event-schema" class="auto internal xref">Section 5.1</a> for the definition of Events in general and
<a href="#ev-fetchkeypackage" class="auto internal xref">Section 5.3.4.3</a> for the <code>ds.fetch_key_packages</code> event.<a href="#section-3.2-3" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.2-4.1">
            <p id="section-3.2-4.1.1"><strong>TODO</strong>: For now, the event fetches key packages based on client identifiers,
not user identifiers. This is because KeyPackage fetching is part of MIMI DS,
which doesn't know what a user is. We could, however, send multiple MIMI DS
requests in a single MIMI protocol request.<a href="#section-3.2-4.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.2-5">If the request was successful, the response contains a list of KeyPackages, one
for each client.<a href="#section-3.2-5" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.2-6.1">
            <p id="section-3.2-6.1.1"><strong>TODO</strong>: For now, responses are simple, we can improve granularity when we
start optimizing.<a href="#section-3.2-6.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.2-7.1">
            <p id="section-3.2-7.1.1"><strong>TODO</strong>: Once we have framing for MIMIResponses, add a reference here.<a href="#section-3.2-7.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="create-a-room">
<section id="section-3.3">
        <h3 id="name-create-a-room">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-create-a-room" class="section-name selfRef">Create a room</a>
        </h3>
<p id="section-3.3-1">Creating a room is done between a client and its local provider and is out of
scope of MIMI. Since Alice creates the room on the server of her local provider,
it becomes the Hub for the room. However, the room policy format is in scope for MIMI.
We assume that this room is a members-only room, and that only users who have
the admin or owner role can add and remove users.<a href="#section-3.3-1" class="pilcrow">¶</a></p>
<p id="section-3.3-2">We also assume that Alice has both the <code>owner</code> and <code>admin</code> roles within the room.<a href="#section-3.3-2" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.3-3.1">
            <p id="section-3.3-3.1.1"><strong>TODO</strong>: Add information on room policy here once we have consensus on what
that looks like.<a href="#section-3.3-3.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="alice-adds-bob">
<section id="section-3.4">
        <h3 id="name-alice-adds-bob">
<a href="#section-3.4" class="section-number selfRef">3.4. </a><a href="#name-alice-adds-bob" class="section-name selfRef">Alice adds Bob</a>
        </h3>
<p id="section-3.4-1">Management of the participants list (i.e. the list of users in the room) is done
through <code>m.room.user</code> events. To add Bob to the room, Alice creates an
<code>m.room.user</code> event. See <a href="#ev-mroomuser" class="auto internal xref">Section 6.7</a> for more information on user state
changes.<a href="#section-3.4-1" class="pilcrow">¶</a></p>
<p id="section-3.4-2">Room state is anchored in the room's underlying MLS group through a GroupContext
Extension, which mirrors all of the room's state variables.<a href="#section-3.4-2" class="pilcrow">¶</a></p>
<p id="section-3.4-3"><code>m.room.user</code> events are MLS proposals, which change the room state outside of
the MLS group immediately upon reception and align the mirror of the room state
in the extension (which is part of the group state) upon the next <code>ds.commit</code>
event. This reflects the MLS proposal-commit paradigm that allows members and
external parties to propose changes, but only members to commit them. See
<a href="#anchoring" class="auto internal xref">Section 5.3.2</a> for more information on how the room state is cryptographically
anchored.<a href="#section-3.4-3" class="pilcrow">¶</a></p>
<p id="section-3.4-4">Alice does not only want to add Bob as a participant, but also Bob's client. To
do that, she sends a <code>ds.commit</code> event (<a href="#ev-commitupdate" class="auto internal xref">Section 5.3.4.2</a>) to the group. As
<code>ds.commit</code> events can contain an arbitrary number of proposals, Alice includes
the <code>m.room.user</code> proposal, as well as a proposal to add Bob's client. She
creates the latter by using the key material she previously fetched from Bob's
server.<a href="#section-3.4-4" class="pilcrow">¶</a></p>
<p id="section-3.4-5">She then sends the resulting <code>ds.commit</code> to the Hub. Upon reception, the Hub
processes the commit and the proposals therein by updating the participant list
to include Bob and the underlying MLS group state to add Bob's client.<a href="#section-3.4-5" class="pilcrow">¶</a></p>
<p id="section-3.4-6">Finally, the Hub fans out the commit event to Bob.<a href="#section-3.4-6" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.4-7.1">
            <p id="section-3.4-7.1.1"><strong>TODO</strong>: Especially when adding new clients, we will want to forward a
<code>ds.commit</code> event selectively, as existing group members will only be
interested in the actual commit, whereas new group members only need the
Welcome.<a href="#section-3.4-7.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="alice-sends-a-message-to-the-room">
<section id="section-3.5">
        <h3 id="name-alice-sends-a-message-to-th">
<a href="#section-3.5" class="section-number selfRef">3.5. </a><a href="#name-alice-sends-a-message-to-th" class="section-name selfRef">Alice sends a message to the room</a>
        </h3>
<p id="section-3.5-1">After Bob has joined the room, Alice creates a message using the MIMI content
format <span>[<a href="#I-D.ietf-mimi-content" class="cite xref">I-D.ietf-mimi-content</a>]</span>, and sends a <code>ds.send_message</code>
(<a href="#ev-sendmessage" class="auto internal xref">Section 5.3.4.5</a>) event to the Hub.<a href="#section-3.5-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="the-hubowning-provider-fans-out-the-message">
<section id="section-3.6">
        <h3 id="name-the-hub-owning-provider-fan">
<a href="#section-3.6" class="section-number selfRef">3.6. </a><a href="#name-the-hub-owning-provider-fan" class="section-name selfRef">The hub/owning provider fans out the message</a>
        </h3>
<p id="section-3.6-1">If the Hub accepts the message it fans the message out to all guest servers,
which in this case is Bob's server.<a href="#section-3.6-1" class="pilcrow">¶</a></p>
<p id="section-3.6-2">Generally, the Hub also fans out any messages which originate from itself (ex:
removing clients of deleted users).<a href="#section-3.6-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="bob-sends-a-message-to-the-room">
<section id="section-3.7">
        <h3 id="name-bob-sends-a-message-to-the-">
<a href="#section-3.7" class="section-number selfRef">3.7. </a><a href="#name-bob-sends-a-message-to-the-" class="section-name selfRef">Bob sends a message to the room</a>
        </h3>
<p id="section-3.7-1">This is no different from Alice sending a message, which is fanned out in
exactly the same way.<a href="#section-3.7-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="bob-adds-a-new-client">
<section id="section-3.8">
        <h3 id="name-bob-adds-a-new-client">
<a href="#section-3.8" class="section-number selfRef">3.8. </a><a href="#name-bob-adds-a-new-client" class="section-name selfRef">Bob adds a new client</a>
        </h3>
<p id="section-3.8-1">For Bob's new client to join the MLS group and therefore fully participate in
the room with Alice, Bob needs to fetch the current group and room information
through a <code>ds.fetch_group_info</code> event (<a href="#ev-fetchgroupinfo" class="auto internal xref">Section 5.3.4.4</a>), which he sends to
the Hub.<a href="#section-3.8-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.8-2.1">
            <p id="section-3.8-2.1.1"><strong>TODO</strong>: in the MLS case, what security properties are needed to protect a
GroupInfo object in the MIMI context are still under discussion. It is
possible that the requester only needs to prove possession of their private
key. The GroupInfo in another context might be sufficiently sensitive that it
should be encrypted from the end client to the hub provider (unreadable by the
local provider).<a href="#section-3.8-2.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.8-3">The new client can use the information to add itself to the group via a
<code>ds.commit</code> that contains an MLS ExternalInit proposal.<a href="#section-3.8-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="alice-adds-cathy">
<section id="section-3.9">
        <h3 id="name-alice-adds-cathy">
<a href="#section-3.9" class="section-number selfRef">3.9. </a><a href="#name-alice-adds-cathy" class="section-name selfRef">Alice adds Cathy</a>
        </h3>
<p id="section-3.9-1">Alice gets the identifier for Cathy and waits for her to join the room in
exactly the same way as in previous steps.<a href="#section-3.9-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="alice-removes-bob-from-the-room">
<section id="section-3.10">
        <h3 id="name-alice-removes-bob-from-the-">
<a href="#section-3.10" class="section-number selfRef">3.10. </a><a href="#name-alice-removes-bob-from-the-" class="section-name selfRef">Alice removes Bob from the room</a>
        </h3>
<p id="section-3.10-1">Alice removes Bob by sending an <code>ds.commit</code> event. The <code>ds.commit</code> event
contains an <code>m.room.user</code> event which removes Bob from the participant list, as
well as proposals to remove Bob's clients.<a href="#section-3.10-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="framing">
<section id="section-4">
      <h2 id="name-framing">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-framing" class="section-name selfRef">Framing</a>
      </h2>
<p id="section-4-1">MIMI protocol messages are sent described using the TLS presentation language
format (<span><a href="https://rfc-editor.org/rfc/rfc8446#section-3" class="relref">Section 3</a> of [<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>).<a href="#section-4-1" class="pilcrow">¶</a></p>
<p id="section-4-2">All MIMI protocol messages are framed by a MIMIMessage.<a href="#section-4-2" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-4-3">
<pre>
enum {
   reserved(0),
   mimi10(1), // MIMI 1.0
   (65535)
} ProtocolVersion;

enum {
   reserverd(0),
   event(1),
   event_response(2),
} MIMIMessageType;

struct {
   // The protocol version this event is created for.
   ProtocolVersion version;

   // The room ID where the event is sent in context of.
   opaque roomId;

   // Who or what sent this event. For example, a user ID.
   opaque sender;

   MIMIMessageType message_type;
   select (MIMIMessage.message_type) {
      case event:
        Event event;
      case event_response:
        EventResponse response;
   }
} MIMIMessage
</pre><a href="#section-4-3" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="rooms-and-events">
<section id="section-5">
      <h2 id="name-rooms-and-events">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-rooms-and-events" class="section-name selfRef">Rooms and Events</a>
      </h2>
<p id="section-5-1">Rooms, described by <span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>, consist of a user participation
list, a cryptographic representation of the room as defined by
<span>[<a href="#I-D.robert-mimi-delivery-service" class="cite xref">I-D.robert-mimi-delivery-service</a>]</span>, policy, and other metadata as needed.<a href="#section-5-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5-2.1">
          <p id="section-5-2.1.1"><strong>TODO</strong>: Consider renaming "event" to something else.<a href="#section-5-2.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-5-3">A room's state is modified, used, and retrieved through <em>events</em>. Some events
are fanned out to other participating servers while other events are operations
performed exclusively with the hub server for a room.<a href="#section-5-3" class="pilcrow">¶</a></p>
<p id="section-5-4">Events that change the state of the room are implemented through MLS proposals
as defined in <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span>, thus allowing the underlying MIMI DS protocol to
anchor the current room state cryptographically. MLS proposals are signed,
allowing every recipient in their path to verify their authenticity.<a href="#section-5-4" class="pilcrow">¶</a></p>
<p id="section-5-5">This document defines additional events to encapsulate MIMI DS protocol
messages, for example, to add clients to a room's underlying MLS group or to
request single-use key material for another user's clients.<a href="#section-5-5" class="pilcrow">¶</a></p>
<p id="section-5-6">Events carry information, and are not required to be persisted. The current
participation and policy state is confirmed by the cryptographic security layer
rather than being confirmed in events specifically.<a href="#section-5-6" class="pilcrow">¶</a></p>
<div id="event-schema">
<section id="section-5.1">
        <h3 id="name-event-schema">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-event-schema" class="section-name selfRef">Event Schema</a>
        </h3>
<p id="section-5.1-1">Events are validated against their TLS presentation language format
(<span><a href="https://rfc-editor.org/rfc/rfc8446#section-3" class="relref">Section 3</a> of [<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>):<a href="#section-5.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.1-2">
<pre>
// See the "MIMI Event Types" IANA registry for values.
// Example: "m.room.info"
opaque EventType;

struct {
   // The event type.
   EventType type;

   // Additional fields may be present as dependent on event type.
   select (Event.type) {
      case "m.room.user":
         // MLSMessage containing a UserEvent proposal
         MLSMessage user_event_proposal;
      case "ds.proposal":
         DSRequest ds_proposal;
      case "ds.commit":
         DSRequest ds_commit;
      case "ds.fetch_key_packages":
         DSRequest fetch_key_packages;
      case "ds.fetch_group_info":
         DSRequest fetch_group_info;
      case "ds.send_message":
         DSRequest send_message;
      // more cases as required by registry
   }
} Event;
</pre><a href="#section-5.1-2" class="pilcrow">¶</a>
</div>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.1-3.1">
            <p id="section-5.1-3.1.1"><strong>TODO</strong>: Consider splitting <code>sender</code> into an object of <code>{type, identifier}</code>.<a href="#section-5.1-3.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.1-4.1">
            <p id="section-5.1-4.1.1"><strong>TODO</strong>: The <code>sender</code> field might be a bit redundant now that signaling is
largely handled through MLS proposals.<a href="#section-5.1-4.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-5.1-5">Note an "event ID" is not specified on the struct. Events are sent ephemerally
and confirmed by the underlying cryptographic group state rather than referenced
by a consistent identifier.<a href="#section-5.1-5" class="pilcrow">¶</a></p>
<p id="section-5.1-6">The "origin server" of an event is the server implied by the <code>sender</code> field.<a href="#section-5.1-6" class="pilcrow">¶</a></p>
<p id="section-5.1-7">Recipients of an event respond with a MIMIMessage of type event_response.<a href="#section-5.1-7" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.1-8">
<pre>
enum {
  reserved(0),
  ok(1),
  key_package(2),
  group_info(3),
  error(4),
} EventResponseType

enum {
  // TODO
} EventErrorType

struct {
  EventErrorType type;

   select (EventResponse.type) {
      // TODO
   }
} EventError

struct {
   EventResponseType type;

   // Additional fields may be present as dependent on event type.
   select (EventResponse.type) {
      case ok:
         struct {};
      case key_package:
         DSResponse key_package;
      case group_info:
         DSResponse group_info;
      case error:
         EventError error;
   }
} EventResponse
</pre><a href="#section-5.1-8" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="room-state">
<section id="section-5.2">
        <h3 id="name-room-state">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-room-state" class="section-name selfRef">Room state</a>
        </h3>
<p id="section-5.2-1">The state of a room consists of the room's RoomID, its policy, and the
participant list (including the role and participation state of each
participant). Also associated with the room is the MLS group managed by the MIMI
DS protocol, which anchors the room state cryptographically as part of the group
state.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<p id="section-5.2-2">While (through the MIMI DS protocol) all parties involved in a room agree on the
room's state, the Hub is the arbiter that decides if a state change is valid.
All state-changing events are sent to the Hub, checked for their validity and
policy conformance before they are forwarded to any follower servers.<a href="#section-5.2-2" class="pilcrow">¶</a></p>
<p id="section-5.2-3">As soon as the Hub accepts an event that changes the room state, its effect is
applied to the room state and future events are validated in the context of that
new state.<a href="#section-5.2-3" class="pilcrow">¶</a></p>
<p id="section-5.2-4">The room state is thus changed based on events, even if the MLS proposal
implementing the event was not yet committed by a client. Note that this only
applies to events changing the room state, but not for MIMI DS specific events
that change the group state. For more information on the proposal-commit
paradigm and the role of the MIMI DS protocol see <a href="#mimi-ds" class="auto internal xref">Section 5.3</a>.<a href="#section-5.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="mimi-ds">
<section id="section-5.3">
        <h3 id="name-cryptographic-room-represen">
<a href="#section-5.3" class="section-number selfRef">5.3. </a><a href="#name-cryptographic-room-represen" class="section-name selfRef">Cryptographic room representation</a>
        </h3>
<p id="section-5.3-1">Each room is represented cryptographically by an MLS group and the Hub that
manages the room uses the MIMI DS protocol specified in
<span>[<a href="#I-D.robert-mimi-delivery-service" class="cite xref">I-D.robert-mimi-delivery-service</a>]</span> to manage that group.<a href="#section-5.3-1" class="pilcrow">¶</a></p>
<p id="section-5.3-2">In particular, the MIMI DS protocol manages the list of group members, i.e. the
list of clients belonging to users currently in the room.<a href="#section-5.3-2" class="pilcrow">¶</a></p>
<div id="proposal-commit-paradigm">
<section id="section-5.3.1">
          <h4 id="name-proposal-commit-paradigm">
<a href="#section-5.3.1" class="section-number selfRef">5.3.1. </a><a href="#name-proposal-commit-paradigm" class="section-name selfRef">Proposal-commit paradigm</a>
          </h4>
<p id="section-5.3.1-1">The MIMI DS protocol uses MLS, which follows a proposal-commit paradigm. Any
party involved in a room (follower server, Hub or clients) can send proposals
(e.g. to add/remove/update clients of a user or to re-initialize the group with
different parameters). However, only clients can send commits, which contain all
valid previously sent proposals and apply them to the MLS group state.<a href="#section-5.3.1-1" class="pilcrow">¶</a></p>
<p id="section-5.3.1-2">The MIMI DS protocol ensures that the Hub, all follower servers and the clients
of all participants (or at least those in the <code>join</code> state) agree on the group
state, which includes the client list and the key material used for message
encryption (although the latter is only available to clients). Since the group
state also includes a copy of the room state at the time of the most recent
commit, it is also covered by the agreement.<a href="#section-5.3.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="anchoring">
<section id="section-5.3.2">
          <h4 id="name-cryptographically-anchoring">
<a href="#section-5.3.2" class="section-number selfRef">5.3.2. </a><a href="#name-cryptographically-anchoring" class="section-name selfRef">Cryptographically anchoring room state</a>
          </h4>
<p id="section-5.3.2-1">To allow all parties involved to agree on the state of the room in addition to
the state of the associated group, the room state is anchored in the MLS group
via a GroupContext extension.<a href="#section-5.3.2-1" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.3.2-2">
<pre>
struct {
   opaque user_id;
   opaque role;
   ParticipationState state;
} ParticipantData

struct {
  opaque room_id;
  ParticipantData participants&lt;V&gt;;
  // TODO: Add any remaining room data
} RoomState;
</pre><a href="#section-5.3.2-2" class="pilcrow">¶</a>
</div>
<p id="section-5.3.2-3">As part of the MIMI DS protocol, clients create commits to update the group
state, which are then included in MIMI DS specific events. The time between two
commits denotes an epoch.<a href="#section-5.3.2-3" class="pilcrow">¶</a></p>
<p id="section-5.3.2-4">Whenever a client creates a commit, it <span class="bcp14">MUST</span> include all valid proposals accepted
by the Hub during the current epoch. This includes both proposals that carry
room-state changes, as well as proposals sent as part of MIMI DS events.<a href="#section-5.3.2-4" class="pilcrow">¶</a></p>
<p id="section-5.3.2-5">Note that the validity of a proposal depend on the current room state, which may
change during an epoch based on room-state changing events. The changes of these
events are applied to the room state even if the commits that carry the event
information have not yet been committed.<a href="#section-5.3.2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authenticating-proposals">
<section id="section-5.3.3">
          <h4 id="name-authenticating-proposals">
<a href="#section-5.3.3" class="section-number selfRef">5.3.3. </a><a href="#name-authenticating-proposals" class="section-name selfRef">Authenticating proposals</a>
          </h4>
<p id="section-5.3.3-1">The MLS specification <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span> requires that MLS proposals from the Hub and
from follower servers (external senders in MLS terminology) be authenticated
using key material contained in the <code>external_senders</code> extension of the MLS
group. Each MLS group associated with a MIMI room <span class="bcp14">MUST</span> therefore contain an
<code>external_senders</code> extension. That extension <span class="bcp14">MUST</span> contain at least the
Certificate of the Hub.<a href="#section-5.3.3-1" class="pilcrow">¶</a></p>
<p id="section-5.3.3-2">When a user from a follower server becomes a participant in the room, the
Certificate of the follower server <span class="bcp14">MAY</span> be added to the extension. When the last
participant belonging to a follower server leaves the room, the certificate of
that user <span class="bcp14">MUST</span> be removed from the list. Changes to the <code>external_senders</code>
extension only take effect when the MLS proposal containing the event is
committed by a MIMI DS commit. See <a href="#ev-mroomuser" class="auto internal xref">Section 6.7</a> for more information.<a href="#section-5.3.3-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="mimi-ds-events">
<section id="section-5.3.4">
          <h4 id="name-mimi-ds-events">
<a href="#section-5.3.4" class="section-number selfRef">5.3.4. </a><a href="#name-mimi-ds-events" class="section-name selfRef">MIMI DS events</a>
          </h4>
<p id="section-5.3.4-1">The MIMI DS protocol operations are encapsulated in DSRequest structs and
contain a <code>request_type</code> field that details the operation in question. To
disambiguate MIMI DS operations on the event-level, each operation is assigned
its own distinct event type.<a href="#section-5.3.4-1" class="pilcrow">¶</a></p>
<p id="section-5.3.4-2">The MIMI DS protocol deals with authentication of each request and upon
successful processing returns a DSResponse to be sent to the sender of the
event, optionally an MLSMessage for full fan-out and optionally one or more
Welcome messages for fan-out to individual follower servers.<a href="#section-5.3.4-2" class="pilcrow">¶</a></p>
<p id="section-5.3.4-3">Depending on the event, a DSResponse either indicates successful processing, the
requested data (e.g. group information required for joins), or an error message.<a href="#section-5.3.4-3" class="pilcrow">¶</a></p>
<p id="section-5.3.4-4">Messages meant for fan-out are DSFanoutRequests, which contain an MLS message,
as well as information to which clients messages should be fanned out to.<a href="#section-5.3.4-4" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.3.4-5.1">
              <p id="section-5.3.4-5.1.1"><strong>TODO</strong>: Update the MIMI DS doc to allow for messages to contain more than one
proposal and a generic "commit" action.<a href="#section-5.3.4-5.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<div id="ev-proposeupdate">
<section id="section-5.3.4.1">
            <h5 id="name-propose-group-update">
<a href="#section-5.3.4.1" class="section-number selfRef">5.3.4.1. </a><a href="#name-propose-group-update" class="section-name selfRef">Propose group update</a>
            </h5>
<p id="section-5.3.4.1-1"><strong>Event type</strong>: <code>ds.proposal</code><a href="#section-5.3.4.1-1" class="pilcrow">¶</a></p>
<p id="section-5.3.4.1-2">Group members, the Hub, and follower servers can use this event to propose
updates to the group. Each such event contains one or more proposals that can be
committed to update the state of the MLS group associated with the room. In
particular, this event can be used to add, remove or update clients in the
group.<a href="#section-5.3.4.1-2" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.3.4.1-3">
<pre>
struct {
  DSRequest proposal;
} DSProposal
</pre><a href="#section-5.3.4.1-3" class="pilcrow">¶</a>
</div>
<p id="section-5.3.4.1-4"><strong>Additional validation rules</strong>:<a href="#section-5.3.4.1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.3.4.1-5.1">
                <p id="section-5.3.4.1-5.1.1">Clients can only be added to the group if the associated user is on the
participant list and in the <code>join</code> state.<a href="#section-5.3.4.1-5.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</section>
</div>
<div id="ev-commitupdate">
<section id="section-5.3.4.2">
            <h5 id="name-commit-group-update">
<a href="#section-5.3.4.2" class="section-number selfRef">5.3.4.2. </a><a href="#name-commit-group-update" class="section-name selfRef">Commit group update</a>
            </h5>
<p id="section-5.3.4.2-1"><strong>Event type</strong>: <code>ds.commit</code><a href="#section-5.3.4.2-1" class="pilcrow">¶</a></p>
<p id="section-5.3.4.2-2">Group members can use this event to commit any pending proposals (including both
group updates and room updates). The sender of this event can include additional
group updates without proposing them separately through the <code>ds.proposal</code>
event.<a href="#section-5.3.4.2-2" class="pilcrow">¶</a></p>
<p id="section-5.3.4.2-3">Note that this event can also be used by a client to add itself to the group. To
do that, the sender requires the current group information (see
<a href="#ev-fetchgroupinfo" class="auto internal xref">Section 5.3.4.4</a>).<a href="#section-5.3.4.2-3" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.3.4.2-4">
<pre>
struct {
  DSRequest commitBundle;
} DSCommit
</pre><a href="#section-5.3.4.2-4" class="pilcrow">¶</a>
</div>
<p id="section-5.3.4.2-5"><strong>Additional validation rules</strong>:<a href="#section-5.3.4.2-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.3.4.2-6.1">
                <p id="section-5.3.4.2-6.1.1">Clients can only be added to the group if the associated user is on the
participant list and in the <code>join</code> state.<a href="#section-5.3.4.2-6.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</section>
</div>
<div id="ev-fetchkeypackage">
<section id="section-5.3.4.3">
            <h5 id="name-fetch-keypackage">
<a href="#section-5.3.4.3" class="section-number selfRef">5.3.4.3. </a><a href="#name-fetch-keypackage" class="section-name selfRef">Fetch KeyPackage</a>
            </h5>
<p id="section-5.3.4.3-1"><strong>Event type</strong>: <code>ds.fetch_key_packages</code><a href="#section-5.3.4.3-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.3.4.3-2.1">
                <p id="section-5.3.4.3-2.1.1"><strong>TODO</strong>: For now, we assume that KeyPackages are fetched directly, i.e. not in the
context of a room and via a Hub. This might change in the future. If it does
change, this event needs an additional authentication mechanism.<a href="#section-5.3.4.3-2.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-5.3.4.3-3">Group members can use this event to request a
KeyPackage from the Hub or another follower server.<a href="#section-5.3.4.3-3" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.3.4.3-4">
<pre>
struct {
  DSRequest fetch_key_packages;
} DSFetchKeyPackages
</pre><a href="#section-5.3.4.3-4" class="pilcrow">¶</a>
</div>
<p id="section-5.3.4.3-5"><strong>Additional validation rules</strong>:<a href="#section-5.3.4.3-5" class="pilcrow">¶</a></p>
<p id="section-5.3.4.3-6">None<a href="#section-5.3.4.3-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="ev-fetchgroupinfo">
<section id="section-5.3.4.4">
            <h5 id="name-fetch-group-information">
<a href="#section-5.3.4.4" class="section-number selfRef">5.3.4.4. </a><a href="#name-fetch-group-information" class="section-name selfRef">Fetch group information</a>
            </h5>
<p id="section-5.3.4.4-1"><strong>Event type</strong>: <code>ds.fetch_group_info</code><a href="#section-5.3.4.4-1" class="pilcrow">¶</a></p>
<p id="section-5.3.4.4-2">Group members or follower servers can use this event to request group
information from the Hub. Up-to-date group information is required for clients
to be able to add themselves to a group via the <code>ds.commit</code> event. The
group info returned to the sender includes any pending proposals.<a href="#section-5.3.4.4-2" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.3.4.4-3">
<pre>
struct {
  DSRequest fetch_group_info;
} DSFetchGroupInfo
</pre><a href="#section-5.3.4.4-3" class="pilcrow">¶</a>
</div>
<p id="section-5.3.4.4-4"><strong>Additional validation rules</strong>:<a href="#section-5.3.4.4-4" class="pilcrow">¶</a></p>
<p id="section-5.3.4.4-5">None<a href="#section-5.3.4.4-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="ev-sendmessage">
<section id="section-5.3.4.5">
            <h5 id="name-send-message">
<a href="#section-5.3.4.5" class="section-number selfRef">5.3.4.5. </a><a href="#name-send-message" class="section-name selfRef">Send Message</a>
            </h5>
<p id="section-5.3.4.5-1"><strong>Event type</strong>: <code>ds.send_message</code><a href="#section-5.3.4.5-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.3.4.5-2.1">
                <p id="section-5.3.4.5-2.1.1"><strong>TODO</strong>: This is not a proposal and there is no way for the Hub or follower servers
to authenticate this event at the moment. We might want to a way to do that
later.<a href="#section-5.3.4.5-2.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-5.3.4.5-3">Group members can use this event to request to send an encrypted (application)
message to the other group members.<a href="#section-5.3.4.5-3" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.3.4.5-4">
<pre>
struct {
  DSRequest send_message;
} DSSendMessage
</pre><a href="#section-5.3.4.5-4" class="pilcrow">¶</a>
</div>
<p id="section-5.3.4.5-5"><strong>Additional validation rules</strong>:<a href="#section-5.3.4.5-5" class="pilcrow">¶</a></p>
<p id="section-5.3.4.5-6">None<a href="#section-5.3.4.5-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="room-creation">
<section id="section-5.4">
        <h3 id="name-creation">
<a href="#section-5.4" class="section-number selfRef">5.4. </a><a href="#name-creation" class="section-name selfRef">Creation</a>
        </h3>
<p id="section-5.4-1">Rooms (and the underlying MLS groups) are first created within the provider, out
of scope from MIMI. When the room is exposed to another server over the MIMI
protocol, such as with an explicit invite to another user, the creating server
<span class="bcp14">MUST</span> produce the following details:<a href="#section-5.4-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.4-2.1">
            <p id="section-5.4-2.1.1">An <code>m.room.info</code> (<a href="#ev-mroomcreate" class="auto internal xref">Section 5.4.1</a>) event describing the encryption
and policy details for the room.<a href="#section-5.4-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.4-2.2">
            <p id="section-5.4-2.2.1">A universally unique room ID (represented by the room info event).<a href="#section-5.4-2.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.4-2.3">
            <p id="section-5.4-2.3.1">An <code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 6.7</a>) event which invites the desired user.<a href="#section-5.4-2.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.4-2.4">
            <p id="section-5.4-2.4.1">Any relevant cryptographic state needed to verify the invite is legitimate.
For example, the ciphersuite used by the cryptographic security layer.<a href="#section-5.4-2.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-5.4-3">This is the minimum state required by a MIMI room. Room creators <span class="bcp14">MAY</span> wish to
include additional details in the initial state, such as configuration of the
room's policy, adding the creator's other clients to the MLS group state, etc.<a href="#section-5.4-3" class="pilcrow">¶</a></p>
<div id="ev-mroomcreate">
<section id="section-5.4.1">
          <h4 id="name-mroominfo">
<a href="#section-5.4.1" class="section-number selfRef">5.4.1. </a><a href="#name-mroominfo" class="section-name selfRef"><code>m.room.info</code></a>
          </h4>
<p id="section-5.4.1-1">The <code>m.room.info</code> event contains the current room state, thus allowing servers
to bootstrap the room. Note that this event does not contain any of the
cryptographic state of the underlying MIMI DS group. Clients that want to join a
room need to use a <code>ds.fetch_group_info</code> event to obtain the information
required to join the room.<a href="#section-5.4.1-1" class="pilcrow">¶</a></p>
<p id="section-5.4.1-2"><strong>Event type</strong>: <code>m.room.info</code><a href="#section-5.4.1-2" class="pilcrow">¶</a></p>
<p id="section-5.4.1-3"><strong>Additional event fields</strong>:<a href="#section-5.4.1-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.4.1-4">
<pre>
struct {
  RoomState room_state;
} InfoEvent;
</pre><a href="#section-5.4.1-4" class="pilcrow">¶</a>
</div>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.4.1-5.1">
              <p id="section-5.4.1-5.1.1"><strong>TODO</strong>: Include fields for policy information (previously called a "policy
ID" in ralston-mimi-signaling).<a href="#section-5.4.1-5.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-5.4.1-6"><strong>Fanout considerations</strong>:<a href="#section-5.4.1-6" class="pilcrow">¶</a></p>
<p id="section-5.4.1-7"><code>InfoEvent</code> is <em>unsigned</em> in all cases it is used, but authenticated implicitly
through the transport layer (<a href="#transport" class="auto internal xref">Section 7</a>). The room info event is used during
invites to ensure the server is capable of participating in the room and is not
fanned out more generally. See <a href="#op-check" class="auto internal xref">Section 7.3.2</a> for usage.<a href="#section-5.4.1-7" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="membership">
<section id="section-6">
      <h2 id="name-user-participation-and-clie">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-user-participation-and-clie" class="section-name selfRef">User Participation and Client Membership</a>
      </h2>
<p id="section-6-1">In a MIMI room, users are <em>participants</em> with an associated
<em>participation state</em> whereas clients of those users are <em>members</em> of the
cryptographic state. The user's participation state is updated concurrent to or
before changes are made to the cryptographic state.<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2">Users will always exist in one of the following participation states:<a href="#section-6-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6-3">
<pre>
enum {
   invite,  // "Invited" state.
   join,    // "Joined" state.
   ban,     // "Banned" state.
   knock,   // "Knocking" state.
} ParticipationState;
</pre><a href="#section-6-3" class="pilcrow">¶</a>
</div>
<p id="section-6-4">These states allow a user to remain logically "joined" to the conversation when
they have zero encryption-capable clients available. The user will not be able to see
messages sent while they had no clients, but can add their clients to the
cryptographic state at any time. A user with zero clients in the cryptographic
state is considered to be an <em>inactive participant</em>. Users with one or more clients
in the cryptographic state are <em>active participants</em>.<a href="#section-6-4" class="pilcrow">¶</a></p>
<p id="section-6-5">All servers with at least one user of theirs in the "joined" participation state
are considered to be "in" or "participating" in the room. Events which require
full fanout (<a href="#fanout" class="auto internal xref">Section 7.3.1.1</a>) are sent to all participating servers by default. Some
events <span class="bcp14">MAY</span> be sent to additional servers as needed by their fanout considerations.<a href="#section-6-5" class="pilcrow">¶</a></p>
<p id="section-6-6">The participant list is anchored in the cryptographic state of the room as
described in <a href="#anchoring" class="auto internal xref">Section 5.3.2</a>.<a href="#section-6-6" class="pilcrow">¶</a></p>
<div id="adds">
<section id="section-6.1">
        <h3 id="name-adds">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-adds" class="section-name selfRef">Adds</a>
        </h3>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.1-1.1">
            <p id="section-6.1-1.1.1"><strong>TODO</strong>: We will probably want some kind of mechanism here that allows the
adder to signal that they are authorized (by the added user) to add the added
user to the room.<a href="#section-6.1-1.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-6.1-2">An <em>add</em> is when a user adds another user to the list of participants in the
<em>join</em> state. The <code>m.room.user</code> event that effects this change is typically sent
as part of a commit that also adds the user's clients to the room's MLS group.<a href="#section-6.1-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.1-3">
<li id="section-6.1-3.1">
            <p id="section-6.1-3.1.1">The adder generates an <code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 6.7</a>) event to add the
target user.<a href="#section-6.1-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-3.2">
            <p id="section-6.1-3.2.1">The adder sends (<a href="#op-send" class="auto internal xref">Section 7.3.1</a>) the <code>m.room.user</code> event to the hub server. If
the adder is a client, the event is likely sent as part of a <code>ds.commit</code>
event.<a href="#section-6.1-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-3.3">
            <p id="section-6.1-3.3.1">The hub server validates the event to ensure the following:<a href="#section-6.1-3.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1-3.3.2.1">
                <p id="section-6.1-3.3.2.1.1">The target user of the add <span class="bcp14">MUST NOT</span> already be in the banned or joined
states.<a href="#section-6.1-3.3.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-6.1-3.3.2.2">
                <p id="section-6.1-3.3.2.2.1">The sender of the invite <span class="bcp14">MUST</span> already be in the joined state.<a href="#section-6.1-3.3.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li id="section-6.1-3.4">
            <p id="section-6.1-3.4.1">If the event is invalid, it is rejected. Otherwise, it is forwarded by the
hub to the servers of all participants in the joined state. This includes the
server of the user added by the event.<a href="#section-6.1-3.4.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-3.5">
            <p id="section-6.1-3.5.1">The target user (or its server) can reject the addition by sending an
<code>m.room.user</code> event that proposes the removal of the user and its clients
(<a href="#leaves" class="auto internal xref">Section 6.4</a>).<a href="#section-6.1-3.5.1" class="pilcrow">¶</a></p>
</li>
        </ol>
</section>
</div>
<div id="invites">
<section id="section-6.2">
        <h3 id="name-invites">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-invites" class="section-name selfRef">Invites</a>
        </h3>
<p id="section-6.2-1">An <em>invite</em> is when a user (or more specifically, a user's client) adds another
user to the list of participants in the <code>invite</code> state.<a href="#section-6.2-1" class="pilcrow">¶</a></p>
<p id="section-6.2-2">Once the user is on the participant list (and has been notified of this fact by
the Hub), one of the user's clients can add itself, as well as any other clients
to the room's underlying group.<a href="#section-6.2-2" class="pilcrow">¶</a></p>
<p id="section-6.2-3">Updating the target user's participation state is done using the following
steps, and is visualized in <a href="#fig-invites" class="auto internal xref">Figure 1</a>.<a href="#section-6.2-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.2-4">
<li id="section-6.2-4.1">
            <p id="section-6.2-4.1.1">The inviter's server generates an <code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 6.7</a>)
event to invite the target user. Typically this begins with a
client-initiated request to the server using the provider-specific API.<a href="#section-6.2-4.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.2-4.2">
            <p id="section-6.2-4.2.1">The inviter's server sends (<a href="#op-send" class="auto internal xref">Section 7.3.1</a>) the <code>m.room.user</code> event to the hub
server.<a href="#section-6.2-4.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.2-4.3">
            <p id="section-6.2-4.3.1">The hub server validates the event to ensure the following:<a href="#section-6.2-4.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.2-4.3.2.1">
                <p id="section-6.2-4.3.2.1.1">The target user of the invite <span class="bcp14">MUST NOT</span> already be in the banned or joined
states.<a href="#section-6.2-4.3.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-6.2-4.3.2.2">
                <p id="section-6.2-4.3.2.2.1">The sender of the invite <span class="bcp14">MUST</span> already be in the joined state.<a href="#section-6.2-4.3.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li id="section-6.2-4.4">
            <p id="section-6.2-4.4.1">If the event is invalid, it is rejected. Otherwise, it is forwarded by the
hub to the target user's server to give it the opportunity to reject the
invite early in the process. This is described by <a href="#op-check" class="auto internal xref">Section 7.3.2</a>.<a href="#section-6.2-4.4.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.2-4.5">
            <p id="section-6.2-4.5.1">If the target server rejected the event, the event is rejected by the hub as
well. Otherwise, the event is fanned out (<a href="#fanout" class="auto internal xref">Section 7.3.1.1</a>) to all participating
servers, plus the target server if not already participating.<a href="#section-6.2-4.5.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-6.2-5">At this stage, the <em>user</em> is now invited but their clients are not members of
the cryptographic state. The invite is delivered to the target's clients through
relevant provider-specific API where the user can then accept or decline the invite.<a href="#section-6.2-5" class="pilcrow">¶</a></p>
<p id="section-6.2-6">If the user declines the invite, they are removed from the participant list.
Accepting is done by joining (<a href="#joins" class="auto internal xref">Section 6.3</a>) the room.<a href="#section-6.2-6" class="pilcrow">¶</a></p>
<span id="name-invite-happy-path"></span><div id="fig-invites">
<figure id="figure-1">
          <div id="section-6.2-7.1">
            <div class="alignLeft art-svg artwork" id="section-6.2-7.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="496" width="568" viewBox="0 0 568 496" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,32 L 8,64" fill="none" stroke="black"></path>
                <path d="M 24,72 L 24,480" fill="none" stroke="black"></path>
                <path d="M 40,32 L 40,64" fill="none" stroke="black"></path>
                <path d="M 232,112 L 232,144" fill="none" stroke="black"></path>
                <path d="M 272,32 L 272,64" fill="none" stroke="black"></path>
                <path d="M 296,72 L 296,480" fill="none" stroke="black"></path>
                <path d="M 320,32 L 320,64" fill="none" stroke="black"></path>
                <path d="M 512,240 L 512,272" fill="none" stroke="black"></path>
                <path d="M 528,32 L 528,64" fill="none" stroke="black"></path>
                <path d="M 544,72 L 544,480" fill="none" stroke="black"></path>
                <path d="M 560,32 L 560,64" fill="none" stroke="black"></path>
                <path d="M 8,32 L 40,32" fill="none" stroke="black"></path>
                <path d="M 272,32 L 320,32" fill="none" stroke="black"></path>
                <path d="M 528,32 L 560,32" fill="none" stroke="black"></path>
                <path d="M 8,64 L 40,64" fill="none" stroke="black"></path>
                <path d="M 272,64 L 320,64" fill="none" stroke="black"></path>
                <path d="M 528,64 L 560,64" fill="none" stroke="black"></path>
                <path d="M 32,112 L 232,112" fill="none" stroke="black"></path>
                <path d="M 32,144 L 232,144" fill="none" stroke="black"></path>
                <path d="M 32,192 L 288,192" fill="none" stroke="black"></path>
                <path d="M 304,240 L 512,240" fill="none" stroke="black"></path>
                <path d="M 304,272 L 512,272" fill="none" stroke="black"></path>
                <path d="M 32,320 L 288,320" fill="none" stroke="black"></path>
                <path d="M 304,368 L 536,368" fill="none" stroke="black"></path>
                <path d="M 304,416 L 536,416" fill="none" stroke="black"></path>
                <path d="M 32,464 L 288,464" fill="none" stroke="black"></path>
                <path d="M 304,464 L 536,464" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="544,464 532,458.4 532,469.6" fill="black" transform="rotate(0,536,464)"></polygon>
                <polygon class="arrowhead" points="544,368 532,362.4 532,373.6" fill="black" transform="rotate(0,536,368)"></polygon>
                <polygon class="arrowhead" points="312,416 300,410.4 300,421.6" fill="black" transform="rotate(180,304,416)"></polygon>
                <polygon class="arrowhead" points="312,272 300,266.4 300,277.6" fill="black" transform="rotate(180,304,272)"></polygon>
                <polygon class="arrowhead" points="296,192 284,186.4 284,197.6" fill="black" transform="rotate(0,288,192)"></polygon>
                <polygon class="arrowhead" points="40,464 28,458.4 28,469.6" fill="black" transform="rotate(180,32,464)"></polygon>
                <polygon class="arrowhead" points="40,320 28,314.4 28,325.6" fill="black" transform="rotate(180,32,320)"></polygon>
                <polygon class="arrowhead" points="40,144 28,138.4 28,149.6" fill="black" transform="rotate(180,32,144)"></polygon>
                <g class="text">
                  <text x="24" y="52">A</text>
                  <text x="296" y="52">Hub</text>
                  <text x="544" y="52">B</text>
                  <text x="60" y="100">Create</text>
                  <text x="136" y="100">m.room.user</text>
                  <text x="212" y="100">invite</text>
                  <text x="52" y="180">Send</text>
                  <text x="96" y="180">event</text>
                  <text x="152" y="180">request</text>
                  <text x="224" y="180">initiated</text>
                  <text x="340" y="228">Validate</text>
                  <text x="424" y="228">m.room.user</text>
                  <text x="496" y="228">event</text>
                  <text x="72" y="308">200</text>
                  <text x="100" y="308">OK</text>
                  <text x="124" y="308">to</text>
                  <text x="156" y="308">send</text>
                  <text x="200" y="308">event</text>
                  <text x="256" y="308">request</text>
                  <text x="328" y="356">Check</text>
                  <text x="376" y="356">event</text>
                  <text x="432" y="356">request</text>
                  <text x="496" y="404">200</text>
                  <text x="524" y="404">OK</text>
                  <text x="136" y="452">Async</text>
                  <text x="188" y="452">fanout</text>
                  <text x="228" y="452">of</text>
                  <text x="264" y="452">event</text>
                  <text x="328" y="452">Async</text>
                  <text x="380" y="452">fanout</text>
                  <text x="420" y="452">of</text>
                  <text x="456" y="452">event</text>
                </g>
              </svg><a href="#section-6.2-7.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-invite-happy-path" class="selfRef">Invite happy path</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="joins">
<section id="section-6.3">
        <h3 id="name-joins">
<a href="#section-6.3" class="section-number selfRef">6.3. </a><a href="#name-joins" class="section-name selfRef">Joins</a>
        </h3>
<p id="section-6.3-1">Users join a room either in response to an invite (therefore accepting it) or
after discovering it as a public room. In both cases, the user first updates
their participation state before the cryptographic security layer is engaged to
add their clients. Note that both of these actions can be performed either
sequentially, or through a single <code>ds.commit</code> event.<a href="#section-6.3-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.3-2.1">
            <p id="section-6.3-2.1.1"><strong>TODO</strong>: Describe policy considerations for what makes a room "public".<a href="#section-6.3-2.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.3-3.1">
            <p id="section-6.3-3.1.1"><strong>TODO</strong>: Move the following paragraph to the MIMI DS subsection describing
<code>ds.commit</code>.<a href="#section-6.3-3.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-6.3-4">A user already in the join participation state <span class="bcp14">MAY</span> add and remove their own
clients from the cryptographic state at will. Clients are unable to remove
themselves via <code>ds.commit</code>, however they are able to propose that they be
removed in the next commit via <code>ds.proposal</code>.<a href="#section-6.3-4" class="pilcrow">¶</a></p>
<p id="section-6.3-5">The joining user can follow one of two flows. Either it first updates the
participation state and then adds their clients, or it perfoms both actions in
the same event.<a href="#section-6.3-5" class="pilcrow">¶</a></p>
<p id="section-6.3-6">The two-step flow looks as follows:<a href="#section-6.3-6" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.3-7">
<li id="section-6.3-7.1">
            <p id="section-6.3-7.1.1">Option a: The joiner's server generates an <code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 6.7</a>)
event to add the user.<a href="#section-6.3-7.1.1" class="pilcrow">¶</a></p>
<p id="section-6.3-7.1.2">
Option b: The joiner's client generates a commit that contains an
<code>m.room.user</code> event, as well as an Add proposal for itself (this requires
that the client has previously obtained a the room's group info through a
<code>ds.fetch_group_info</code> event (<a href="#ev-fetchgroupinfo" class="auto internal xref">Section 5.3.4.4</a>)). The joiner's server
generates a <code>ds.commit</code> event from the commit.<a href="#section-6.3-7.1.2" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.3-7.2">
            <p id="section-6.3-7.2.1">The joiners's server sends (<a href="#op-send" class="auto internal xref">Section 7.3.1</a>) the generated event to the hub
server.<a href="#section-6.3-7.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.3-7.3">
            <p id="section-6.3-7.3.1">The hub server validates the event to ensure the following:<a href="#section-6.3-7.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.3-7.3.2.1">
                <p id="section-6.3-7.3.2.1.1">The joining user <span class="bcp14">MUST NOT</span> already be in the banned from the room.<a href="#section-6.3-7.3.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-6.3-7.3.2.2">
                <p id="section-6.3-7.3.2.2.1">The sender and joining user <span class="bcp14">MUST</span> be the same.<a href="#section-6.3-7.3.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li id="section-6.3-7.4">
            <p id="section-6.3-7.4.1">If the event is invalid, it is rejected. Otherwise, the event is fanned out
(<a href="#fanout" class="auto internal xref">Section 7.3.1.1</a>) to all participating servers, plus the joiner's server as they
are now participating in the room too.<a href="#section-6.3-7.4.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-6.3-8">If the user was added to the room via a standalone <code>m.room.user</code> event, the
user's clients are able to add themselves to the cryptographic group state via
one or more <code>ds.commit</code> events after fetching the room's current information via
a <code>ds.fetch_group_info</code> event.<a href="#section-6.3-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="leaves">
<section id="section-6.4">
        <h3 id="name-leaves-kicks">
<a href="#section-6.4" class="section-number selfRef">6.4. </a><a href="#name-leaves-kicks" class="section-name selfRef">Leaves/Kicks</a>
        </h3>
<p id="section-6.4-1">Leaving a room can signal a user declining an invite, voluntarily leaving the
room, or being kicked (removed) from the room. When the sender and target of
an <code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 6.7</a>) leave event are different, the target user
is being kicked. Otherwise the event represents a voluntary leave or declined
invite (if the previous participation state was "invited").<a href="#section-6.4-1" class="pilcrow">¶</a></p>
<p id="section-6.4-2">Like with other participation/membership operations, a user's leave is initiated
by updating their participation state first. This is done by sending
(<a href="#op-send" class="auto internal xref">Section 7.3.1</a>) the relevant <code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 6.7</a>) state event to the
hub, which validates it as follows:<a href="#section-6.4-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.4-3.1">
            <p id="section-6.4-3.1.1">If the target and sender are the same, the user <span class="bcp14">MUST</span> be in the invited,
joined, or knocking participation state.<a href="#section-6.4-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.4-3.2">
            <p id="section-6.4-3.2.1">Otherwise:<a href="#section-6.4-3.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.4-3.2.2.1">
                <p id="section-6.4-3.2.2.1.1">The target user of the kick <span class="bcp14">MUST</span> be in the joined participation state.<a href="#section-6.4-3.2.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-6.4-3.2.2.2">
                <p id="section-6.4-3.2.2.2.1">The sender for a kick <span class="bcp14">MUST</span> be in the joined participation state.<a href="#section-6.4-3.2.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.4-4.1">
            <p id="section-6.4-4.1.1"><strong>TODO</strong>: Include special case permissions constraints.<a href="#section-6.4-4.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-6.4-5">If the event is valid, it is fanned out (<a href="#fanout" class="auto internal xref">Section 7.3.1.1</a>) to all particpating
servers, plus the target user's server.<a href="#section-6.4-5" class="pilcrow">¶</a></p>
<p id="section-6.4-6">The next <code>ds.commit</code> event <span class="bcp14">MUST</span> remove <em>all</em> of the target user's clients. If
multiple users leave the room, all of their clients <span class="bcp14">MUST</span> be removed in the same
operation. Other cryptographically-relevant changes <span class="bcp14">MAY</span> be committed alongside
the removals, however the operation <span class="bcp14">MUST</span> at a minimum remove the affected
clients.<a href="#section-6.4-6" class="pilcrow">¶</a></p>
<p id="section-6.4-7">The hub server <span class="bcp14">MAY</span> be permitted to generate the needed changes to remove the
affected clients, requiring that those changes be confirmed/accepted by a client
remaining in the group promptly.<a href="#section-6.4-7" class="pilcrow">¶</a></p>
<p id="section-6.4-8">As mentioned in <a href="#joins" class="auto internal xref">Section 6.3</a>, a user already in the join participation state <span class="bcp14">MAY</span>
add and remove their own clients from the cryptographic state at will.<a href="#section-6.4-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="bans">
<section id="section-6.5">
        <h3 id="name-bans">
<a href="#section-6.5" class="section-number selfRef">6.5. </a><a href="#name-bans" class="section-name selfRef">Bans</a>
        </h3>
<p id="section-6.5-1">Bans imply kick, and are operated the same way as <a href="#leaves" class="auto internal xref">Section 6.4</a>, though with the
<code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 6.7</a>) state event using a <code>ban</code> participation state.<a href="#section-6.5-1" class="pilcrow">¶</a></p>
<p id="section-6.5-2">In contrast to leaving users, banned users remain on the participant list in the
<code>ban</code> state.<a href="#section-6.5-2" class="pilcrow">¶</a></p>
<p id="section-6.5-3">An added exception on the validation is also applied to permit preemptive bans:
the target user is not required to be in the joined state to allow the
participation state change.<a href="#section-6.5-3" class="pilcrow">¶</a></p>
<p id="section-6.5-4">Unbans can be performed by removing a user in the banned participation
state from the participant list <a href="#leaves" class="auto internal xref">Section 6.4</a>.<a href="#section-6.5-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="knocks">
<section id="section-6.6">
        <h3 id="name-knocks">
<a href="#section-6.6" class="section-number selfRef">6.6. </a><a href="#name-knocks" class="section-name selfRef">Knocks</a>
        </h3>
<p id="section-6.6-1">In this state, the sender of a knock is requesting an invite (<a href="#invites" class="auto internal xref">Section 6.2</a>) to
the room. They do not have access to the cryptographic state.<a href="#section-6.6-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.6-2.1">
            <p id="section-6.6-2.1.1"><strong>TODO</strong>: Discuss if this participation state is desirable, and figure out
details for how it works. It'd likely just be an <code>m.room.user</code> state event
with no MLS interaction, like invites are.<a href="#section-6.6-2.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.6-3.1">
            <p id="section-6.6-3.1.1"><strong>TODO</strong>: If we have an Add event as discussed in a TODO in the "Invites"
section, an "Add" would probably be the response to a knock.<a href="#section-6.6-3.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="ev-mroomuser">
<section id="section-6.7">
        <h3 id="name-mroomuser">
<a href="#section-6.7" class="section-number selfRef">6.7. </a><a href="#name-mroomuser" class="section-name selfRef"><code>m.room.user</code></a>
        </h3>
<p id="section-6.7-1"><strong>Event type</strong>: <code>m.room.user</code><a href="#section-6.7-1" class="pilcrow">¶</a></p>
<p id="section-6.7-2">An <code>m.room.user</code> event can be used to change the participation state of a user.<a href="#section-6.7-2" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.7-3.1">
            <p id="section-6.7-3.1.1"><strong>TODO</strong>: Do we also want this to be able to change a participant's role?<a href="#section-6.7-3.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-6.7-4">It is transported via an MLS proposal of type UserEvent. If the event adds a
user to the room and it is the first user in the room that belongs to the
sending follower server, the UserEvent <span class="bcp14">MAY</span> contain the Certificate that can be
used to validate external proposals from that follower server. If it does, the
commit that contains the proposal adds the Certificate to <code>external_senders</code>
extension of the underlying MLS group.<a href="#section-6.7-4" class="pilcrow">¶</a></p>
<p id="section-6.7-5">If the event removes the last user of a follower server from a room, the commit
that contains the MLS proposal that carries the event removes the Certificate of
that follower server from the extension.<a href="#section-6.7-5" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.7-6.1">
            <p id="section-6.7-6.1.1"><strong>TODO</strong>: This proposal needs to be added to the IANA proposal list, or
specified as an extension proposal as specified in the MLS extensions
document. We might want to have one MIMIProposal type that in turn can
encapsulate more than just this event.<a href="#section-6.7-6.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<div class="lang-tls sourcecode" id="section-6.7-7">
<pre>
enum {
   invite,
   join,
   leave,
   ban,
   knock,
} ParticipationStateChange;

struct {
   // The user ID being affected by this participation state change.
   opaque targetUserId;

   // The new participation state for the target user. "Leave" removes
   // the user from the list.
   ParticipationStateChange state;

   // Optional human-readable reason for the change. Typically most
   // useful on bans and knocks.
   opaque [[reason]];
   optional&lt;Certificate&gt; follower_server_certificate;
} UserEvent;
</pre><a href="#section-6.7-7" class="pilcrow">¶</a>
</div>
<p id="section-6.7-8"><strong>Additional validation rules</strong>:<a href="#section-6.7-8" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.7-9.1">
            <p id="section-6.7-9.1.1">Rules described by <a href="#invites" class="auto internal xref">Section 6.2</a>, <a href="#joins" class="auto internal xref">Section 6.3</a>, <a href="#leaves" class="auto internal xref">Section 6.4</a>, <a href="#bans" class="auto internal xref">Section 6.5</a>, <a href="#knocks" class="auto internal xref">Section 6.6</a>.<a href="#section-6.7-9.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.7-9.2">
            <p id="section-6.7-9.2.1">The proposal <span class="bcp14">MUST</span> be authenticated as an MLS message based on the room's
underlying MLS group.<a href="#section-6.7-9.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.7-10.1">
            <p id="section-6.7-10.1.1"><strong>TODO</strong>: Include validation rules for permissions.<a href="#section-6.7-10.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-6.7-11"><strong>Fanout considerations</strong>:<a href="#section-6.7-11" class="pilcrow">¶</a></p>
<p id="section-6.7-12">Each <code>m.room.user</code> event is fanned out as normal (<a href="#fanout" class="auto internal xref">Section 7.3.1.1</a>). The event <span class="bcp14">MAY</span> be
sent to additional servers, as required by <a href="#invites" class="auto internal xref">Section 6.2</a>, <a href="#joins" class="auto internal xref">Section 6.3</a>, <a href="#leaves" class="auto internal xref">Section 6.4</a>,
<a href="#bans" class="auto internal xref">Section 6.5</a>, <a href="#knocks" class="auto internal xref">Section 6.6</a>.<a href="#section-6.7-12" class="pilcrow">¶</a></p>
<p id="section-6.7-13"><strong>Additional validation rules</strong>:<a href="#section-6.7-13" class="pilcrow">¶</a></p>
<p id="section-6.7-14">None.<a href="#section-6.7-14" class="pilcrow">¶</a></p>
<p id="section-6.7-15"><strong>Fanout considerations</strong>:<a href="#section-6.7-15" class="pilcrow">¶</a></p>
<p id="section-6.7-16">This event is not fanned out.<a href="#section-6.7-16" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="transport">
<section id="section-7">
      <h2 id="name-transport">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-transport" class="section-name selfRef">Transport</a>
      </h2>
<p id="section-7-1">Servers communicate with each other over HTTP <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>]</span> by "sending" events
(<a href="#event-schema" class="auto internal xref">Section 5.1</a>) to each other. Responses are also events for ease of handling.<a href="#section-7-1" class="pilcrow">¶</a></p>
<div id="authentication">
<section id="section-7.1">
        <h3 id="name-authentication">
<a href="#section-7.1" class="section-number selfRef">7.1. </a><a href="#name-authentication" class="section-name selfRef">Authentication</a>
        </h3>
<p id="section-7.1-1">All endpoints, with the exception of <code>.well-known</code> endpoints, use the mutually
authenticated mode of TLS <span>[<a href="#RFC5246" class="cite xref">RFC5246</a>]</span>. This provides guarantees that each
server is speaking to an expected party.<a href="#section-7.1-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-7.1-2.1">
            <p id="section-7.1-2.1.1"><strong>TODO</strong>: More information specific to how TLS should be used, i.e. mandate
best practices that make sense in a mutually authenticated scenario that
involves two WebPKI based certificates.<a href="#section-7.1-2.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-7.1-3">Individual events <span class="bcp14">MAY</span> transit between multiple servers. TLS provides
point-to-point security properties while an event's <code>signature</code> provides
authenticity over multiple hops.<a href="#section-7.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="endpoint-discovery">
<section id="section-7.2">
        <h3 id="name-endpoint-discovery">
<a href="#section-7.2" class="section-number selfRef">7.2. </a><a href="#name-endpoint-discovery" class="section-name selfRef">Endpoint Discovery</a>
        </h3>
<p id="section-7.2-1">A messaging provider that wants to query the endpoint of another messaging
provider first has to discover the fully qualified domain name it can use to
communicate with that provider. It does so by performing a GET request to
<code>https://example.org/.well-known/mimi/domain</code>. example.org could, for example,
answer by providing the domain <code>mimi.example.org</code> (assuming that this is where
it responds to the REST endpoints defined in <a href="#rest-api" class="auto internal xref">Section 7.3</a>).<a href="#section-7.2-1" class="pilcrow">¶</a></p>
<p id="section-7.2-2">The expected response format is simply a <code>text/plain</code> body containing the fully
qualified domain name.<a href="#section-7.2-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.2-3">
<pre>
GET https://example.org/.well-known/mimi/domain

Response
mimi.example.org
</pre><a href="#section-7.2-3" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="rest-api">
<section id="section-7.3">
        <h3 id="name-rest-endpoints">
<a href="#section-7.3" class="section-number selfRef">7.3. </a><a href="#name-rest-endpoints" class="section-name selfRef">REST Endpoints</a>
        </h3>
<p id="section-7.3-1">The following REST endpoints can be used to communicate with a MIMI server.<a href="#section-7.3-1" class="pilcrow">¶</a></p>
<p id="section-7.3-2">All operations rely on TLS-encoded structs and therefore requests and responses
<span class="bcp14">SHOULD</span> use a <code>Content-Type</code> of <code>application/octet-stream</code>.<a href="#section-7.3-2" class="pilcrow">¶</a></p>
<div id="op-send">
<section id="section-7.3.1">
          <h4 id="name-send-event">
<a href="#section-7.3.1" class="section-number selfRef">7.3.1. </a><a href="#name-send-event" class="section-name selfRef">Send Event</a>
          </h4>
<p id="section-7.3.1-1">Asks the server to send an event (<a href="#event-schema" class="auto internal xref">Section 5.1</a>). Each event is subject to
additional validation and handling within this endpoint, such as ensuring the
room's policy is not violated.<a href="#section-7.3.1-1" class="pilcrow">¶</a></p>
<p id="section-7.3.1-2">Follower servers in a room <span class="bcp14">MUST</span> only send to the hub server. The hub server is
responsible for further fanout (<a href="#fanout" class="auto internal xref">Section 7.3.1.1</a>) if required by the event, after the
send request has been completed.<a href="#section-7.3.1-2" class="pilcrow">¶</a></p>
<p id="section-7.3.1-3">Follower servers receiving an event from another
follower server <span class="bcp14">MUST</span> reject the request with a <code>400</code> HTTP status code. The hub
server <span class="bcp14">MUST</span> validate the event according to the event's rules, then perform any
additional actions on the event as required by the event. For example, the hub
server may check that an invite is legal under the room's policy, then ensure
the target server accepts the event with <a href="#op-check" class="auto internal xref">Section 7.3.2</a>, then finally continue
processing.<a href="#section-7.3.1-3" class="pilcrow">¶</a></p>
<p id="section-7.3.1-4">Rejected send requests <span class="bcp14">MUST</span> return a <code>400</code> HTTP status code. Accepted send
requests <span class="bcp14">MUST</span> return a <code>200</code> HTTP status code, and an event in the response body
if one is applicable.<a href="#section-7.3.1-4" class="pilcrow">¶</a></p>
<p id="section-7.3.1-5">If the event requires fanout (<a href="#fanout" class="auto internal xref">Section 7.3.1.1</a>), the event is then fanned out
<a href="#fanout" class="auto internal xref">Section 7.3.1.1</a> to relevant servers in the room.<a href="#section-7.3.1-5" class="pilcrow">¶</a></p>
<p id="section-7.3.1-6">Follower servers <span class="bcp14">SHOULD</span> apply the same validation as hub servers upon receiving
a send request to identify potentially malicious hub servers.<a href="#section-7.3.1-6" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.3.1-7">
<pre>
POST /send
Content-Type: application/octet-stream

Body
TLS-serialized Event

Response
TLS-serialized Event, or empty if no useful event.
</pre><a href="#section-7.3.1-7" class="pilcrow">¶</a>
</div>
<p id="section-7.3.1-8">Servers <span class="bcp14">SHOULD</span> retry this request with exponential backoff (to a limit) if they
receive timeout/network errors.<a href="#section-7.3.1-8" class="pilcrow">¶</a></p>
<div id="fanout">
<section id="section-7.3.1.1">
            <h5 id="name-fanout">
<a href="#section-7.3.1.1" class="section-number selfRef">7.3.1.1. </a><a href="#name-fanout" class="section-name selfRef">Fanout</a>
            </h5>
<p id="section-7.3.1.1-1">A hub server fans an event out by using the send endpoint described above on all
participating servers in the room. A server is considered "participating" if it
has at least one user in the joined participation state, described by
<a href="#membership" class="auto internal xref">Section 6</a>.<a href="#section-7.3.1.1-1" class="pilcrow">¶</a></p>
<p id="section-7.3.1.1-2">Additional servers <span class="bcp14">MAY</span> have the event sent to them if required by the steps
leading up to fanout.<a href="#section-7.3.1.1-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="op-check">
<section id="section-7.3.2">
          <h4 id="name-check-invite-event">
<a href="#section-7.3.2" class="section-number selfRef">7.3.2. </a><a href="#name-check-invite-event" class="section-name selfRef">Check Invite Event</a>
          </h4>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-7.3.2-1.1">
              <p id="section-7.3.2-1.1.1"><strong>TODO</strong>: Consider reducing this down to <code>m.room.check_invite</code> or something,
to reuse <code>/send</code>.<a href="#section-7.3.2-1.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-7.3.2-2">Used by the hub server to ensure a follower server can (and is willing to)
process an incoming invite. The called server <span class="bcp14">MAY</span> use this opportunity to ensure
the inviting user has general consent to invite the target user. For example,
ensuring the invite does not appear spammy in nature and if the inviter already
has a connection with the invitee.<a href="#section-7.3.2-2" class="pilcrow">¶</a></p>
<p id="section-7.3.2-3">If the server does not recognize the event format of the <code>InfoEvent</code>
(<a href="#ev-mroomcreate" class="auto internal xref">Section 5.4.1</a>) event, or does not understand the policy/encryption
configuration contained within, it <span class="bcp14">MUST</span> reject the request.<a href="#section-7.3.2-3" class="pilcrow">¶</a></p>
<p id="section-7.3.2-4">The request <span class="bcp14">MAY</span> be rejected with a <code>400</code> HTTP status code. If everything looks
OK to the server, it responds with a <code>200</code> HTTP status code.<a href="#section-7.3.2-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.3.2-5">
<pre>
struct {
   // The `m.room.user` invite event.
   Event invite;

   // The room creation information.
   InfoEvent roomInfo;
} CheckInviteRequest;
</pre><a href="#section-7.3.2-5" class="pilcrow">¶</a>
</div>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-7.3.2-6.1">
              <p id="section-7.3.2-6.1.1"><strong>TODO</strong>: If we plan to keep this as an independent request, it will need a
protocol version field.<a href="#section-7.3.2-6.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<div class="alignLeft art-text artwork" id="section-7.3.2-7">
<pre>
POST /check-invite
Content-Type: application/octet-stream

Body
TLS-serialized CheckInviteRequest

Response
Any meaningful information. The pass/fail is identified by the HTTP response
status code, not the response body.
</pre><a href="#section-7.3.2-7" class="pilcrow">¶</a>
</div>
<p id="section-7.3.2-8">The hub server <span class="bcp14">SHOULD</span> consider a network error as a rejection. It is expected
that the original sender will attempt to re-send the invite once the server is
reachable again.<a href="#section-7.3.2-8" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="security-considerations">
<section id="section-8">
      <h2 id="name-security-considerations">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-8-1">Overall, the user participation state leads any possible MLS group state to
ensure malicious clients are not able to easily get access to messages.<a href="#section-8-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-8-2.1">
          <p id="section-8-2.1.1"><strong>TODO</strong>: Other security guarantees? Consensus may be required here.<a href="#section-8-2.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="iana-considerations">
<section id="section-9">
      <h2 id="name-iana-considerations">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-9-1">IANA has created the following registries:<a href="#section-9-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9-2.1">
          <p id="section-9-2.1.1">MIMI Event Types<a href="#section-9-2.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<div id="mimi-event-types">
<section id="section-9.1">
        <h3 id="name-mimi-event-types">
<a href="#section-9.1" class="section-number selfRef">9.1. </a><a href="#name-mimi-event-types" class="section-name selfRef">MIMI Event Types</a>
        </h3>
<p id="section-9.1-1">An event type denotes the nature of a payload contained in an event, in the
context of the MIMI protocol. The event type is a string composed of substrings
separated by dots.<a href="#section-9.1-1" class="pilcrow">¶</a></p>
<p id="section-9.1-2">The first substring is "m", followed by the logical container being affected
(typically just "room"), then a number of descriptor strings.<a href="#section-9.1-2" class="pilcrow">¶</a></p>
<p id="section-9.1-3">Example: <code>m.room.info</code><a href="#section-9.1-3" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-9.1-4.1">
            <p id="section-9.1-4.1.1"><strong>TODO</strong>: Does IANA need any other information for legal event types?<a href="#section-9.1-4.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
</section>
</div>
<section id="section-10">
      <h2 id="name-references">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<div id="sec-normative-references">
<section id="section-10.1">
        <h3 id="name-normative-references">
<a href="#section-10.1" class="section-number selfRef">10.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="I-D.barnes-mimi-arch">[I-D.barnes-mimi-arch]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refTitle">"An Architecture for More Instant Messaging Interoperability (MIMI)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-barnes-mimi-arch-02</span>, <time datetime="2023-10-23" class="refDate">23 October 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-barnes-mimi-arch-02">https://datatracker.ietf.org/doc/html/draft-barnes-mimi-arch-02</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.robert-mimi-delivery-service">[I-D.robert-mimi-delivery-service]</dt>
        <dd>
<span class="refAuthor">Robert, R.</span> and <span class="refAuthor">K. Kohbrok</span>, <span class="refTitle">"MIMI Delivery Service"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-robert-mimi-delivery-service-06</span>, <time datetime="2023-11-06" class="refDate">6 November 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-robert-mimi-delivery-service-06">https://datatracker.ietf.org/doc/html/draft-robert-mimi-delivery-service-06</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5246">[RFC5246]</dt>
        <dd>
<span class="refAuthor">Dierks, T.</span> and <span class="refAuthor">E. Rescorla</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.2"</span>, <span class="seriesInfo">RFC 5246</span>, <span class="seriesInfo">DOI 10.17487/RFC5246</span>, <time datetime="2008-08" class="refDate">August 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc5246">https://www.rfc-editor.org/rfc/rfc5246</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7231">[RFC7231]</dt>
        <dd>
<span class="refAuthor">Fielding, R., Ed.</span> and <span class="refAuthor">J. Reschke, Ed.</span>, <span class="refTitle">"Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content"</span>, <span class="seriesInfo">RFC 7231</span>, <span class="seriesInfo">DOI 10.17487/RFC7231</span>, <time datetime="2014-06" class="refDate">June 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc7231">https://www.rfc-editor.org/rfc/rfc7231</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
        <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9110">[RFC9110]</dt>
        <dd>
<span class="refAuthor">Fielding, R., Ed.</span>, <span class="refAuthor">Nottingham, M., Ed.</span>, and <span class="refAuthor">J. Reschke, Ed.</span>, <span class="refTitle">"HTTP Semantics"</span>, <span class="seriesInfo">STD 97</span>, <span class="seriesInfo">RFC 9110</span>, <span class="seriesInfo">DOI 10.17487/RFC9110</span>, <time datetime="2022-06" class="refDate">June 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9110">https://www.rfc-editor.org/rfc/rfc9110</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9420">[RFC9420]</dt>
      <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Beurdouche, B.</span>, <span class="refAuthor">Robert, R.</span>, <span class="refAuthor">Millican, J.</span>, <span class="refAuthor">Omara, E.</span>, and <span class="refAuthor">K. Cohn-Gordon</span>, <span class="refTitle">"The Messaging Layer Security (MLS) Protocol"</span>, <span class="seriesInfo">RFC 9420</span>, <span class="seriesInfo">DOI 10.17487/RFC9420</span>, <time datetime="2023-07" class="refDate">July 2023</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9420">https://www.rfc-editor.org/rfc/rfc9420</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
<div id="sec-informative-references">
<section id="section-10.2">
        <h3 id="name-informative-references">
<a href="#section-10.2" class="section-number selfRef">10.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="I-D.ietf-mimi-content">[I-D.ietf-mimi-content]</dt>
        <dd>
<span class="refAuthor">Mahy, R.</span>, <span class="refTitle">"More Instant Messaging Interoperability (MIMI) message content"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-mimi-content-01</span>, <time datetime="2023-10-23" class="refDate">23 October 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-mimi-content-01">https://datatracker.ietf.org/doc/html/draft-ietf-mimi-content-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.kohbrok-mimi-transport">[I-D.kohbrok-mimi-transport]</dt>
        <dd>
<span class="refAuthor">Kohbrok, K.</span> and <span class="refAuthor">R. Robert</span>, <span class="refTitle">"MIMI Transport"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-kohbrok-mimi-transport-01</span>, <time datetime="2023-09-21" class="refDate">21 September 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-kohbrok-mimi-transport-01">https://datatracker.ietf.org/doc/html/draft-kohbrok-mimi-transport-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.mahy-mimi-identity">[I-D.mahy-mimi-identity]</dt>
        <dd>
<span class="refAuthor">Mahy, R.</span>, <span class="refTitle">"More Instant Messaging Interoperability (MIMI) Identity Concepts"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-mahy-mimi-identity-02</span>, <time datetime="2023-07-10" class="refDate">10 July 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-mahy-mimi-identity-02">https://datatracker.ietf.org/doc/html/draft-mahy-mimi-identity-02</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ralston-mimi-policy">[I-D.ralston-mimi-policy]</dt>
        <dd>
<span class="refAuthor">Ralston, T.</span> and <span class="refAuthor">M. Hodgson</span>, <span class="refTitle">"MIMI Policy Envelope"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ralston-mimi-policy-00</span>, <time datetime="2023-09-22" class="refDate">22 September 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ralston-mimi-policy-00">https://datatracker.ietf.org/doc/html/draft-ralston-mimi-policy-00</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ralston-mimi-signaling">[I-D.ralston-mimi-signaling]</dt>
      <dd>
<span class="refAuthor">Ralston, T.</span> and <span class="refAuthor">M. Hodgson</span>, <span class="refTitle">"MIMI Signaling Protocol"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ralston-mimi-signaling-00</span>, <time datetime="2023-09-22" class="refDate">22 September 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ralston-mimi-signaling-00">https://datatracker.ietf.org/doc/html/draft-ralston-mimi-signaling-00</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
</section>
<div id="acknowledgments">
<section id="appendix-A">
      <h2 id="name-acknowledgments">
<a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="appendix-A-1.1">
          <p id="appendix-A-1.1.1"><strong>TODO</strong>: Refactor acknowledgements to match sections of interest.<a href="#appendix-A-1.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="appendix-A-2">This document is the consolidation of the following documents:<a href="#appendix-A-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-3.1">
          <p id="appendix-A-3.1.1"><span>[<a href="#I-D.kohbrok-mimi-transport" class="cite xref">I-D.kohbrok-mimi-transport</a>]</span> forms the majority of <a href="#transport" class="auto internal xref">Section 7</a>.<a href="#appendix-A-3.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="appendix-A-3.2">
          <p id="appendix-A-3.2.1"><span>[<a href="#I-D.robert-mimi-delivery-service" class="cite xref">I-D.robert-mimi-delivery-service</a>]</span> describes details for <a href="#membership" class="auto internal xref">Section 6</a>,
subsections of <a href="#rest-api" class="auto internal xref">Section 7.3</a> (per transport draft).<a href="#appendix-A-3.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="appendix-A-3.3">
          <p id="appendix-A-3.3.1"><span>[<a href="#I-D.ralston-mimi-signaling" class="cite xref">I-D.ralston-mimi-signaling</a>]</span> describes <a href="#event-schema" class="auto internal xref">Section 5.1</a>,
<a href="#room-creation" class="auto internal xref">Section 5.4</a>, details of <a href="#membership" class="auto internal xref">Section 6</a>, and subsections of <a href="#rest-api" class="auto internal xref">Section 7.3</a>.<a href="#appendix-A-3.3.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="appendix-A-4">Aspects of <span>[<a href="#I-D.ralston-mimi-policy" class="cite xref">I-D.ralston-mimi-policy</a>]</span> are additionally taken into
consideration in this document through subsections of <a href="#membership" class="auto internal xref">Section 6</a>, but is
largely unincorporated and may require updates to match this document's
specifics.<a href="#appendix-A-4" class="pilcrow">¶</a></p>
<p id="appendix-A-5"><span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span> was additionally used throughout the writing
of this document.<a href="#appendix-A-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="contributors">
<section id="appendix-B">
      <h2 id="name-contributors">
<a href="#name-contributors" class="section-name selfRef">Contributors</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Rohan Mahy</span></div>
<div dir="auto" class="left"><span class="org">Wire</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:rohan.mahy@wire.com" class="email">rohan.mahy@wire.com</a>
</div>
</address>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-C">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Travis Ralston</span></div>
<div dir="auto" class="left"><span class="org">The Matrix.org Foundation C.I.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:travisr@matrix.org" class="email">travisr@matrix.org</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Konrad Kohbrok</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:konrad.kohbrok@datashrine.de" class="email">konrad.kohbrok@datashrine.de</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Raphael Robert</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ietf@raphaelrobert.com" class="email">ietf@raphaelrobert.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Matthew Hodgson</span></div>
<div dir="auto" class="left"><span class="org">The Matrix.org Foundation C.I.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:matthew@matrix.org" class="email">matthew@matrix.org</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
