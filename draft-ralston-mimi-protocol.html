<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>More Instant Messaging Interoperability (MIMI) using HTTPS and MLS</title>
<meta content="Travis Ralston" name="author">
<meta content="
       The More Instant Messaging Interoperability (MIMI) working group is chartered to
use Messaging Layer Security (MLS)   for its encryption/security
layers. This document implements the architecture described by  ,
detailing the components required to achieve MLS-secured messaging
interoperability. 
    " name="description">
<meta content="xml2rfc 3.18.2" name="generator">
<meta content="mimi" name="keyword">
<meta content="interoperable messaging" name="keyword">
<meta content="chat" name="keyword">
<meta content="secure messaging" name="keyword">
<meta content="draft-ralston-mimi-protocol-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.18.2
    Python 3.11.6
    ConfigArgParse 1.5.3
    google-i18n-address 3.1.0
    intervaltree 3.1.0
    Jinja2 3.1.2
    lxml 4.9.3
    platformdirs 3.11.0
    pycountry 22.3.5
    PyYAML 6.0
    requests 2.31.0
    setuptools 67.7.2
    six 1.16.0
    wcwidth 0.2.8
-->
<link href="draft-ralston-mimi-protocol.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
:is(ol, ul) :is(ol, ul) {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  line-height: 1;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
}
dl.olPercent {
  --indent: 5ch;
}
dl > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl.dlNewline > dt {
  float: none;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
dl.olPercent > dt {
  min-width: calc(var(--indent) - 2ch);
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:first-child, .break:first-child + *) {
  margin-top: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:last-child) {
  margin-bottom: 0;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0;
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    overflow-x: auto;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
}
a.pilcrow[href] { color: var(--pilcrow-weak); }
a.pilcrow[href]:hover { text-decoration: none; }
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
}
#identifiers dt {
  width: var(--identifier-width);
  min-width: var(--identifier-width);
  clear: left;
  float: left;
  text-align: right;
  margin-right: 1ch;
}
#identifiers dd {
  margin: 0;
  margin-left: calc(1em + var(--identifier-width)) !important;
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 2px 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 10ch;
  margin-right: 1.5ch;
}
.references dt:target::before {
  content: "⇒";
  width: 15px;
  margin: 0 10px 0 -25px;
}
.references dd {
  margin-left: 12ch !important;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 1px 0 0 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul :is(p, li) {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre, .vcard {
    page-break-inside: avoid;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  :is(h2, h3, h4, h5, h6)+*, dd {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
  .toplink {
    display: none;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Provide styling for table cell text alignment */
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">MIMI+MLS Protocol</td>
<td class="right">October 2023</td>
</tr></thead>
<tfoot><tr>
<td class="left">Ralston</td>
<td class="center">Expires 28 April 2024</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">More Instant Messaging Interoperability</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ralston-mimi-protocol-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2023-10-26" class="published">26 October 2023</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2024-04-28">28 April 2024</time></dd>
<dt class="label-authors">Author:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">T. Ralston, <span class="editor">Ed.</span>
</div>
<div class="org">The Matrix.org Foundation C.I.C.</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">More Instant Messaging Interoperability (MIMI) using HTTPS and MLS</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">The More Instant Messaging Interoperability (MIMI) working group is chartered to
use Messaging Layer Security (MLS) <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span> for its encryption/security
layers. This document implements the architecture described by <span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>,
detailing the components required to achieve MLS-secured messaging
interoperability.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-about-this-document">
<a href="#name-about-this-document" class="section-name selfRef">About This Document</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">
        The latest revision of this draft can be found at <span><a href="https://turt2live.github.io/ietf-mimi-protocol/draft-ralston-mimi-protocol.html">https://turt2live.github.io/ietf-mimi-protocol/draft-ralston-mimi-protocol.html</a></span>.
        Status information for this document may be found at <span><a href="https://datatracker.ietf.org/doc/draft-ralston-mimi-protocol/">https://datatracker.ietf.org/doc/draft-ralston-mimi-protocol/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">
        Discussion of this document takes place on the
        More Instant Messaging Interoperability Working Group mailing list (<span><a href="mailto:mimi@ietf.org">mailto:mimi@ietf.org</a></span>),
        which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/mimi/">https://mailarchive.ietf.org/arch/browse/mimi/</a></span>.
        Subscribe at <span><a href="https://www.ietf.org/mailman/listinfo/mimi/">https://www.ietf.org/mailman/listinfo/mimi/</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
<p id="section-note.1-4">Source for this draft and an issue tracker can be found at
        <span><a href="https://github.com/turt2live/ietf-mimi-protocol">https://github.com/turt2live/ietf-mimi-protocol</a></span>.<a href="#section-note.1-4" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 28 April 2024.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2023 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-conventions-and-definitions" class="internal xref">Conventions and Definitions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-rooms-and-events" class="internal xref">Rooms and Events</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1" class="keepWithNext"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-event-schema" class="internal xref">Event Schema</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-authentication" class="internal xref">Authentication</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2.2.1">
                    <p id="section-toc.1-1.3.2.2.2.1.1"><a href="#section-3.2.1" class="auto internal xref">3.2.1</a>.  <a href="#name-reference-hash" class="internal xref">Reference Hash</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2.2.2">
                    <p id="section-toc.1-1.3.2.2.2.2.1"><a href="#section-3.2.2" class="auto internal xref">3.2.2</a>.  <a href="#name-content-hash" class="internal xref">Content Hash</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2.2.3">
                    <p id="section-toc.1-1.3.2.2.2.3.1"><a href="#section-3.2.3" class="auto internal xref">3.2.3</a>.  <a href="#name-signatures" class="internal xref">Signatures</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="auto internal xref">3.3</a>.  <a href="#name-creation" class="internal xref">Creation</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3.2.1">
                    <p id="section-toc.1-1.3.2.3.2.1.1"><a href="#section-3.3.1" class="auto internal xref">3.3.1</a>.  <a href="#name-mroomcreate" class="internal xref"><code>m.room.create</code></a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.4">
                <p id="section-toc.1-1.3.2.4.1"><a href="#section-3.4" class="auto internal xref">3.4</a>.  <a href="#name-hub-server-selection" class="internal xref">Hub Server Selection</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5">
                <p id="section-toc.1-1.3.2.5.1"><a href="#section-3.5" class="auto internal xref">3.5</a>.  <a href="#name-reinitialization" class="internal xref">ReInitialization</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.6">
                <p id="section-toc.1-1.3.2.6.1"><a href="#section-3.6" class="auto internal xref">3.6</a>.  <a href="#name-mroomredaction" class="internal xref"><code>m.room.redaction</code></a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-user-participation-and-clie" class="internal xref">User Participation and Client Membership</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="auto internal xref">4.1</a>.  <a href="#name-invites" class="internal xref">Invites</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="auto internal xref">4.2</a>.  <a href="#name-joins" class="internal xref">Joins</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2.2.1">
                    <p id="section-toc.1-1.4.2.2.2.1.1"><a href="#section-4.2.1" class="auto internal xref">4.2.1</a>.  <a href="#name-external-commit-flow" class="internal xref">External Commit Flow</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2.2.2">
                    <p id="section-toc.1-1.4.2.2.2.2.1"><a href="#section-4.2.2" class="auto internal xref">4.2.2</a>.  <a href="#name-welcome-flow" class="internal xref">Welcome Flow</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a href="#section-4.3" class="auto internal xref">4.3</a>.  <a href="#name-leaves-kicks" class="internal xref">Leaves/Kicks</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4">
                <p id="section-toc.1-1.4.2.4.1"><a href="#section-4.4" class="auto internal xref">4.4</a>.  <a href="#name-bans" class="internal xref">Bans</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5">
                <p id="section-toc.1-1.4.2.5.1"><a href="#section-4.5" class="auto internal xref">4.5</a>.  <a href="#name-knocks" class="internal xref">Knocks</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6">
                <p id="section-toc.1-1.4.2.6.1"><a href="#section-4.6" class="auto internal xref">4.6</a>.  <a href="#name-mroomuser" class="internal xref"><code>m.room.user</code></a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-application-messages" class="internal xref">Application Messages</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="auto internal xref">5.1</a>.  <a href="#name-mroomencrypted" class="internal xref"><code>m.room.encrypted</code></a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-transport" class="internal xref">Transport</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="auto internal xref">6.1</a>.  <a href="#name-authentication-2" class="internal xref">Authentication</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="auto internal xref">6.2</a>.  <a href="#name-endpoint-discovery" class="internal xref">Endpoint Discovery</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3">
                <p id="section-toc.1-1.6.2.3.1"><a href="#section-6.3" class="auto internal xref">6.3</a>.  <a href="#name-rest-endpoints" class="internal xref">REST Endpoints</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3.2.1">
                    <p id="section-toc.1-1.6.2.3.2.1.1"><a href="#section-6.3.1" class="auto internal xref">6.3.1</a>.  <a href="#name-send-event" class="internal xref">Send Event</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3.2.2">
                    <p id="section-toc.1-1.6.2.3.2.2.1"><a href="#section-6.3.2" class="auto internal xref">6.3.2</a>.  <a href="#name-check-invite-event" class="internal xref">Check Invite Event</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3.2.3">
                    <p id="section-toc.1-1.6.2.3.2.3.1"><a href="#section-6.3.3" class="auto internal xref">6.3.3</a>.  <a href="#name-retrieve-event" class="internal xref">Retrieve Event</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3.2.4">
                    <p id="section-toc.1-1.6.2.3.2.4.1"><a href="#section-6.3.4" class="auto internal xref">6.3.4</a>.  <a href="#name-retrieve-keypackages" class="internal xref">Retrieve KeyPackages</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3.2.5">
                    <p id="section-toc.1-1.6.2.3.2.5.1"><a href="#section-6.3.5" class="auto internal xref">6.3.5</a>.  <a href="#name-external-group-join" class="internal xref">External Group Join</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3.2.6">
                    <p id="section-toc.1-1.6.2.3.2.6.1"><a href="#section-6.3.6" class="auto internal xref">6.3.6</a>.  <a href="#name-add-remove-and-update-mls-g" class="internal xref">Add, Remove, and Update MLS Group Clients</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="auto internal xref">8.1</a>.  <a href="#name-mimi-event-types" class="internal xref">MIMI Event Types</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-references" class="internal xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a href="#section-9.1" class="auto internal xref">9.1</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2">
                <p id="section-toc.1-1.9.2.2.1"><a href="#section-9.2" class="auto internal xref">9.2</a>.  <a href="#name-informative-references" class="internal xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-acknowledgments" class="internal xref">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-authors-address" class="internal xref">Author's Address</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">The More Instant Messaging Interoperability (MIMI) working group is responsible
for specifying the set of protocols required to achieve secure, modern,
messaging interoperability using MLS <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span>. <span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>
outlines an overall architecture for interoperable communications, and this
document implements those components using MLS and HTTP for the security and
specific transport details.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">Each MIMI room uses state events to track user-level participation and
interaction with the room, and an accompanied MLS group for client-level
membership and messaging. The MLS group's membership consists of the clients
which belong to the participating users in the MIMI room.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">MLS describes an abstract concept of a "Delivery Service" (DS) that is
specifically responsible for ordering handshake messages and more generally
delivering messages to the intended recipients. Collectively, all of the servers
in a MIMI room fulfill the Delivery Service role, with the hub server performing
the ordering of handshake messages. The hub server is additionally responsible
for tracking details about the room to assist clients in joining, validating
events and handshake messages, and enforcing the required policy against the
room and MLS group states.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">Servers communicate with each other using a mutually authenticated mode of TLS
<span>[<a href="#RFC5246" class="cite xref">RFC5246</a>]</span> over HTTP <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>. This document does not describe a protocol
for clients to communicate with a server. Instead, clients use provider-specific
APIs to accomplish "last mile" delivery of events and messages.<a href="#section-1-4" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-1-5.1">
          <p id="section-1-5.1.1"><strong>TODO</strong>: Describe notion of consent, similar to "connection KeyPackages" in
Section 6 of <span>[<a href="#I-D.robert-mimi-delivery-service" class="cite xref">I-D.robert-mimi-delivery-service</a>]</span>.<a href="#section-1-5.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
"<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="cite xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-2-1" class="pilcrow">¶</a></p>
<p id="section-2-2">Terms and definitions are inherited from <span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>.<a href="#section-2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="rooms-and-events">
<section id="section-3">
      <h2 id="name-rooms-and-events">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-rooms-and-events" class="section-name selfRef">Rooms and Events</a>
      </h2>
<p id="section-3-1">Rooms, described by <span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>, contain both state events and an
associated MLS group for encryption operations. State events are used to frame
information and operations which exist outside of the MLS group, such as the
user participation list, room policy, and other metadata.<a href="#section-3-1" class="pilcrow">¶</a></p>
<p id="section-3-2">Events are sent in context of a room, authenticated against the room's policy,
and ordered by the hub server. Each event additionally contains an <em>event type</em>
to differentiate its payload format from other events. A state event is an event
with a <em>state key</em>. The combination of the event type and state key form a tuple
to establish <em>current state</em>: the most recently sent state events with distinct
type and state key pairs.<a href="#section-3-2" class="pilcrow">¶</a></p>
<p id="section-3-3">The hub server <span class="bcp14">MUST</span> persist at least the current room state, and <span class="bcp14">MAY</span> discard
user participation events for users who are in the <code>leave</code> state. The hub server
<span class="bcp14">SHOULD</span> persist all other events for the benefit of other servers in the room.<a href="#section-3-3" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3-4.1">
          <p id="section-3-4.1.1"><strong>TODO</strong>: Check that this history requirement matches agreed semantics.<a href="#section-3-4.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3-5.1">
          <p id="section-3-5.1.1"><strong>TODO</strong>: Describe where room state is persisted. With this document's
transport, it's stored adjacent to the MLS group. See
<span>[<a href="#I-D.robert-mimi-delivery-service" class="cite xref">I-D.robert-mimi-delivery-service</a>]</span> for possible in-MLS persistence.<a href="#section-3-5.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<div id="event-schema">
<section id="section-3.1">
        <h3 id="name-event-schema">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-event-schema" class="section-name selfRef">Event Schema</a>
        </h3>
<p id="section-3.1-1">Events are authenticated against their TLS presentation language format
(<span><a href="https://rfc-editor.org/rfc/rfc8446#section-3" class="relref">Section 3</a> of [<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>):<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.1-2">
<pre>
// See the "MIMI Event Types" IANA registry for values.
// Example: "m.room.create"
opaque EventType;

struct {
   // The room where the event is sent to.
   opaque roomId;

   // The event type.
   EventType type;

   // If present, the event is a state event.
   opaque [[stateKey]];

   // Who or what sent this event.
   opaque sender;

   // The origin server's content hash of the event.
   // See the "Content Hashes" section for information.
   uint8 contentHash[32];

   // The origin server's signature over the event.
   // See the "Signatures" section for information.
   opaque signature&lt;V&gt;;

   // The event IDs which authorize this event to be sent in the room,
   // as defined by the policy.
   // See the "[Event] Authentication" section for information.
   opaque authEventIds[];

   // The event ID of the parent event. This will be an empty string if
   // the `type` is `m.room.create`.
   opaque prevEventId;

   // Additional fields may be present as dependent on event type.
} Event;
</pre><a href="#section-3.1-2" class="pilcrow">¶</a>
</div>
<p id="section-3.1-3">Note an "event ID" is not specified on the object. The event ID for an event is
the sigil <code>$</code> followed by the URL-Safe Unpadded Base64-encoded reference hash
(<a href="#reference-hash" class="auto internal xref">Section 3.2.1</a>) of the event.<a href="#section-3.1-3" class="pilcrow">¶</a></p>
<p id="section-3.1-4">The "origin server" of an event is the server implied by the <code>sender</code> field.<a href="#section-3.1-4" class="pilcrow">¶</a></p>
<p id="section-3.1-5">Events are immutable once sent, but may be redacted (<a href="#event-auth" class="auto internal xref">Section 3.2</a>) to remove
non-critical information.<a href="#section-3.1-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="event-auth">
<section id="section-3.2">
        <h3 id="name-authentication">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-authentication" class="section-name selfRef">Authentication</a>
        </h3>
<p id="section-3.2-1">Events simultaneously carry information which is critical for the protocol to
operate, and other information which is less essential. The less essential
information is often user-supplied, and ideally can be removed without
"breaking" the room. MIMI supports removing non-critical information from events
through <em>redaction</em>.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">Redaction creates a consistent representation of an event suitable for signing.
It is not an approach for "deleting" an event. Deletions are instead handled by
the content format for application messages in MIMI.<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<p id="section-3.2-3">There are two scenarios where a redaction is applied:<a href="#section-3.2-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-3.2-4">
<li id="section-3.2-4.1">
            <p id="section-3.2-4.1.1">When a mismatched content hash (<a href="#content-hash" class="auto internal xref">Section 3.2.2</a>) for an event is received.<a href="#section-3.2-4.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-3.2-4.2">
            <p id="section-3.2-4.2.1">When an <code>m.room.redaction</code> (<a href="#ev-mroomredaction" class="auto internal xref">Section 3.6</a>) message event is received,
targeting an event.<a href="#section-3.2-4.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-3.2-5">When applying a redaction, all fields described by <a href="#event-schema" class="auto internal xref">Section 3.1</a> <span class="bcp14">MUST NOT</span> be
removed. Individual event types <span class="bcp14">MAY</span> describe additional fields to retain. All
other fields <span class="bcp14">MUST</span> be removed.<a href="#section-3.2-5" class="pilcrow">¶</a></p>
<p id="section-3.2-6">Events are authenticated against their redacted form. If an event fails
authentication, it is <em>rejected</em>. Rejected events are dropped and not forwarded
any further. For example, a hub rejecting an event would not send it to follower
servers. A follower server rejecting an event sent by a hub would not forward it
to local clients.<a href="#section-3.2-6" class="pilcrow">¶</a></p>
<p id="section-3.2-7">The redacted event is signed (<a href="#event-signing" class="auto internal xref">Section 3.2.3</a>) to verify that the event was
sent by the referenced originating server. If the signature verification fails,
the event is rejected.<a href="#section-3.2-7" class="pilcrow">¶</a></p>
<p id="section-3.2-8">Each event references a set of "auth events" which permit the event to be sent.
This field is populated by the hub server upon receipt of a partial event to
send. The specific event types required to be referenced in this field are
described by the room policy, but are typically the <code>m.room.create</code> (<a href="#ev-mroomcreate" class="auto internal xref">Section 3.3.1</a>),
and <code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 4.6</a>) state events at a minimum. If an event is
missing a required auth event, or contains a reference to an unknown/rejected
event, the event is rejected.<a href="#section-3.2-8" class="pilcrow">¶</a></p>
<p id="section-3.2-9">If the event's content hash does not match the calculated content hash, the
event is redacted before being sent any further. Note that if an event is
already manually redacted with a redaction event, it will in most cases fail a
content hash check.<a href="#section-3.2-9" class="pilcrow">¶</a></p>
<p id="section-3.2-10">Individual event types <span class="bcp14">MAY</span> specify additional authentication requirements, such
as field validation or ordering requirements.<a href="#section-3.2-10" class="pilcrow">¶</a></p>
<div id="reference-hash">
<section id="section-3.2.1">
          <h4 id="name-reference-hash">
<a href="#section-3.2.1" class="section-number selfRef">3.2.1. </a><a href="#name-reference-hash" class="section-name selfRef">Reference Hash</a>
          </h4>
<p id="section-3.2.1-1">Events are referenced by ID in relation to each other, forming the room history
and auth chain. If the event ID was a sender-generated value, any server along
the send or receive path could "replace" that event with another perfectly legal
event, both using the same ID.<a href="#section-3.2.1-1" class="pilcrow">¶</a></p>
<p id="section-3.2.1-2">By using a calculated value, namely the reference hash, if a server does try to
replace the event then it would result in a completely different event ID. That
event ID becomes impossible to reference as it wouldn't be part of the proper
room history.<a href="#section-3.2.1-2" class="pilcrow">¶</a></p>
<p id="section-3.2.1-3">An event's reference hash is calculated by redacting it, removing the
<code>signature</code> field if present, then serializing the resulting object. The
serialized binary is then hashed using SHA256 <span>[<a href="#RFC6234" class="cite xref">RFC6234</a>]</span>.<a href="#section-3.2.1-3" class="pilcrow">¶</a></p>
<p id="section-3.2.1-4">To further create an event ID, the resulting hash is encoded using URL-Safe
Unpadded Base64 and prefixed with the <code>$</code> sigil.<a href="#section-3.2.1-4" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.2.1-5.1">
              <p id="section-3.2.1-5.1.1"><strong>TODO</strong>: Reference "URL-Safe Unpadded Base64" specification.<a href="#section-3.2.1-5.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</section>
</div>
<div id="content-hash">
<section id="section-3.2.2">
          <h4 id="name-content-hash">
<a href="#section-3.2.2" class="section-number selfRef">3.2.2. </a><a href="#name-content-hash" class="section-name selfRef">Content Hash</a>
          </h4>
<p id="section-3.2.2-1">An event's content hash prevents servers from modifying details of the event not
covered by the reference hash itself. For example, a room name state event
doesn't have the name itself covered by a reference hash because it's redacted,
so it's instead covered by the content hash, which is in turn covered by the
reference hash. This allows the event to later be redacted without affecting the
event ID of that event.<a href="#section-3.2.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2.2-2">To calculate a content hash, the following fields are removed from the event
first:<a href="#section-3.2.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.2.2-3.1">
              <p id="section-3.2.2-3.1.1"><code>contentHash</code><a href="#section-3.2.2-3.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.2.2-3.2">
              <p id="section-3.2.2-3.2.1"><code>signature</code><a href="#section-3.2.2-3.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.2.2-3.3">
              <p id="section-3.2.2-3.3.1"><code>authEventIds</code><a href="#section-3.2.2-3.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.2.2-3.4">
              <p id="section-3.2.2-3.4.1"><code>prevEventId</code><a href="#section-3.2.2-3.4.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-3.2.2-4"><code>authEventIds</code> and <code>prevEventId</code> are removed because they are populated by the
hub server. The content hash is to preserve the origin server's event, not the
hub server's.<a href="#section-3.2.2-4" class="pilcrow">¶</a></p>
<p id="section-3.2.2-5">The resulting object is then serialized and hashed using SHA256 <span>[<a href="#RFC6234" class="cite xref">RFC6234</a>]</span>.<a href="#section-3.2.2-5" class="pilcrow">¶</a></p>
<p id="section-3.2.2-6">Note that the event is <em>not</em> redacted in the calculation of a content hash. This
is to ensure that <em>all</em> origin-provided fields are protected by a hash and
trigger redaction if a field changed along the send path.<a href="#section-3.2.2-6" class="pilcrow">¶</a></p>
<p id="section-3.2.2-7">The content hash is additionally covered by the reference hash and event
signature.<a href="#section-3.2.2-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="event-signing">
<section id="section-3.2.3">
          <h4 id="name-signatures">
<a href="#section-3.2.3" class="section-number selfRef">3.2.3. </a><a href="#name-signatures" class="section-name selfRef">Signatures</a>
          </h4>
<p id="section-3.2.3-1">An event's content hash covers the unredacted contents, and it's reference hash
covers the redacted event contents (including the content hash). The hashes
alone are not authenticated and require an additional verification mechanism.
Signatures provide the needed authentication mechanism, and are applied by the
event's origin server.<a href="#section-3.2.3-1" class="pilcrow">¶</a></p>
<p id="section-3.2.3-2">Signatures are computed by first redacting the event, then removing the
<code>signature</code>, <code>authEventIds</code>, and <code>prevEventId</code> fields if present. The resulting
object is then serialized and signed using the server's key.<a href="#section-3.2.3-2" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.2.3-3.1">
              <p id="section-3.2.3-3.1.1"><strong>TODO</strong>: Use mTLS keys? Source drafts use Ed25519 keys, but then we need to
distribute keys all over the place.<a href="#section-3.2.3-3.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-3.2.3-4">Like content hashes (<a href="#content-hash" class="auto internal xref">Section 3.2.2</a>), <code>authEventIds</code> and <code>prevEventId</code> are
removed from the event because they are populated by the hub server.<a href="#section-3.2.3-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="room-creation">
<section id="section-3.3">
        <h3 id="name-creation">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-creation" class="section-name selfRef">Creation</a>
        </h3>
<p id="section-3.3-1">Rooms (and therefore MLS groups) are first created within the provider, out of
scope from MIMI. When the room is exposed to another server over the MIMI
protocol, such as with an explicit invite to another user, the creating server
<span class="bcp14">MUST</span> produce the following details:<a href="#section-3.3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.3-2.1">
            <p id="section-3.3-2.1.1">An <code>m.room.create</code> (<a href="#ev-mroomcreate" class="auto internal xref">Section 3.3.1</a>) state event describing the encryption
and policy details for the room.<a href="#section-3.3-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.3-2.2">
            <p id="section-3.3-2.2.1">A universally unique room ID (represented by the create event).<a href="#section-3.3-2.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.3-2.3">
            <p id="section-3.3-2.3.1">An <code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 4.6</a>) state event which points to the create
event as a parent for the create event's <code>sender</code>.<a href="#section-3.3-2.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.3-2.4">
            <p id="section-3.3-2.4.1">An MLS group with a group ID matching the room ID, and contains a device
belonging to the create event's <code>sender</code>.<a href="#section-3.3-2.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.3-3">This is the minimum state required by a MIMI room. Room creators <span class="bcp14">MAY</span> wish to
include additional details in the initial state, such as configuration of the
room's policy, adding the creator's other clients to the MLS group state, etc.<a href="#section-3.3-3" class="pilcrow">¶</a></p>
<div id="ev-mroomcreate">
<section id="section-3.3.1">
          <h4 id="name-mroomcreate">
<a href="#section-3.3.1" class="section-number selfRef">3.3.1. </a><a href="#name-mroomcreate" class="section-name selfRef"><code>m.room.create</code></a>
          </h4>
<p id="section-3.3.1-1"><strong>Event type</strong>: <code>m.room.create</code><a href="#section-3.3.1-1" class="pilcrow">¶</a></p>
<p id="section-3.3.1-2"><strong>State key</strong>: Zero byte length string.<a href="#section-3.3.1-2" class="pilcrow">¶</a></p>
<p id="section-3.3.1-3"><strong>Additional event fields</strong>:<a href="#section-3.3.1-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.3.1-4">
<pre>
struct {
   // TODO
} CreateEvent;
</pre><a href="#section-3.3.1-4" class="pilcrow">¶</a>
</div>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.3.1-5.1">
              <p id="section-3.3.1-5.1.1"><strong>TODO</strong>: Include fields for policy information (previously called a "policy
ID" in ralston-mimi-signaling). Protect this new field from redaction.<a href="#section-3.3.1-5.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.3.1-6.1">
              <p id="section-3.3.1-6.1.1"><strong>TODO</strong>: Include fields for encryption information. Possibly ciphersuite and
similar so a server can check to ensure it supports the MLS dialect? Protect
this new field from redaction.<a href="#section-3.3.1-6.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-3.3.1-7"><strong>Additional authentication rules</strong>:<a href="#section-3.3.1-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.3.1-8.1">
              <p id="section-3.3.1-8.1.1">The event's <code>prevEventId</code> <span class="bcp14">MUST</span> be a zero byte length string.<a href="#section-3.3.1-8.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.3.1-8.2">
              <p id="section-3.3.1-8.2.1">The event's <code>authEventIds</code> <span class="bcp14">MUST</span> be empty.<a href="#section-3.3.1-8.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.3.1-8.3">
              <p id="section-3.3.1-8.3.1">The event <span class="bcp14">MUST</span> be the first event in the room.<a href="#section-3.3.1-8.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</section>
</div>
</section>
</div>
<div id="hub-server-selection">
<section id="section-3.4">
        <h3 id="name-hub-server-selection">
<a href="#section-3.4" class="section-number selfRef">3.4. </a><a href="#name-hub-server-selection" class="section-name selfRef">Hub Server Selection</a>
        </h3>
<p id="section-3.4-1">The hub server for a room is the origin server of the <code>m.room.create</code>
(<a href="#ev-mroomcreate" class="auto internal xref">Section 3.3.1</a>) event.<a href="#section-3.4-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.4-2.1">
            <p id="section-3.4-2.1.1"><strong>TODO</strong>: More sophisticated selection, and possibly transfer of
responsibility.<a href="#section-3.4-2.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="reinit">
<section id="section-3.5">
        <h3 id="name-reinitialization">
<a href="#section-3.5" class="section-number selfRef">3.5. </a><a href="#name-reinitialization" class="section-name selfRef">ReInitialization</a>
        </h3>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.5-1.1">
            <p id="section-3.5-1.1.1"><strong>TODO</strong>: This topic requires further discussion around policy and lifecycle.
See also: Section 3.11 and Section 10.15 of
<span>[<a href="#I-D.robert-mimi-delivery-service" class="cite xref">I-D.robert-mimi-delivery-service</a>]</span>.<a href="#section-3.5-1.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="ev-mroomredaction">
<section id="section-3.6">
        <h3 id="name-mroomredaction">
<a href="#section-3.6" class="section-number selfRef">3.6. </a><a href="#name-mroomredaction" class="section-name selfRef"><code>m.room.redaction</code></a>
        </h3>
<p id="section-3.6-1"><strong>Event type</strong>: <code>m.room.redaction</code><a href="#section-3.6-1" class="pilcrow">¶</a></p>
<p id="section-3.6-2"><strong>State key</strong>: Not present.<a href="#section-3.6-2" class="pilcrow">¶</a></p>
<p id="section-3.6-3"><strong>Additional event fields</strong>:<a href="#section-3.6-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.6-4">
<pre>
struct {
   // The event ID to redact.
   opaque redactedEventId;
} RedactionEvent;
</pre><a href="#section-3.6-4" class="pilcrow">¶</a>
</div>
<p id="section-3.6-5"><strong>Additional authentication rules</strong>:<a href="#section-3.6-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.6-6.1">
            <p id="section-3.6-6.1.1">The <code>redactedEventId</code> <span class="bcp14">MUST</span> be an event in the room.<a href="#section-3.6-6.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.6-6.2">
            <p id="section-3.6-6.2.1">The affected <code>redactedEventId</code> is redacted (<a href="#event-auth" class="auto internal xref">Section 3.2</a>) by the server upon
receipt.<a href="#section-3.6-6.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.6-7">Redaction events are sent to the hub server for fanout with <a href="#op-send" class="auto internal xref">Section 6.3.1</a>.<a href="#section-3.6-7" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="membership">
<section id="section-4">
      <h2 id="name-user-participation-and-clie">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-user-participation-and-clie" class="section-name selfRef">User Participation and Client Membership</a>
      </h2>
<p id="section-4-1">In a MIMI room, users are <em>participants</em> with an associated
<em>participation state</em> whereas clients of those users are <em>members</em> of the MLS
group. In most scenarios, the user's participation state is updated first or
simultaneously with the MLS group membership to enforce membership more easily.<a href="#section-4-1" class="pilcrow">¶</a></p>
<p id="section-4-2">Users will always exist in one of the following participation states:<a href="#section-4-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4-3">
<pre>
enum {
   invite,  // "Invited" state.
   join,    // "Joined" state.
   leave,   // "Left" state (including Kicked).
   ban,     // "Banned" state.
   knock,   // "Knocking" state.
} ParticipationState;
</pre><a href="#section-4-3" class="pilcrow">¶</a>
</div>
<p id="section-4-4">These states allow a user to remain logically "joined" to the conversation when
they have zero MLS-capable clients available. The user will not be able to see
messages sent while they had no clients, but can perform an external join at any
time to get back into the MLS group. A user with zero clients in the MLS group
is considered to be an <em>inactive participant</em>. Users with one or more clients
in the MLS group are <em>active participants</em>.<a href="#section-4-4" class="pilcrow">¶</a></p>
<p id="section-4-5">All servers with at least one user of theirs in the "joined" participation state
are considered to be "in" or "participating" in the room. By default, all events
sent to a room are distrubuted by the hub to participating servers. This is
discussed further in <a href="#fanout" class="auto internal xref">Section 6.3.1.1</a>.<a href="#section-4-5" class="pilcrow">¶</a></p>
<div id="invites">
<section id="section-4.1">
        <h3 id="name-invites">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-invites" class="section-name selfRef">Invites</a>
        </h3>
<p id="section-4.1-1">An <em>invite</em> is when a user (or more specifically, a user's client) is attempting
to introduce <em>all</em> of another user's clients to the room and MLS group. This is
first done by updating the target user's participation state through the hub
server for the room.<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1-2">Updating the target user's participation state is done using the following
steps, and is visualized in <a href="#fig-invites" class="auto internal xref">Figure 1</a>.<a href="#section-4.1-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.1-3">
<li id="section-4.1-3.1">
            <p id="section-4.1-3.1.1">The inviter's server generates an <code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 4.6</a>) state
event to invite the target user. Typically this begins with a
client-initiated request to the server using the provider-specific API.<a href="#section-4.1-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-4.1-3.2">
            <p id="section-4.1-3.2.1">The inviter's server sends (<a href="#op-send" class="auto internal xref">Section 6.3.1</a>) the <code>m.room.user</code> event to the hub
server. If the inviter's server is the hub server, it does the steps
described in <a href="#op-send" class="auto internal xref">Section 6.3.1</a> to complete the event.<a href="#section-4.1-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-4.1-3.3">
            <p id="section-4.1-3.3.1">The hub server validates the event to ensure the following:<a href="#section-4.1-3.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1-3.3.2.1">
                <p id="section-4.1-3.3.2.1.1">The target user of the invite <span class="bcp14">MUST NOT</span> already be in the banned or joined
states.<a href="#section-4.1-3.3.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.1-3.3.2.2">
                <p id="section-4.1-3.3.2.2.1">The sender of the invite <span class="bcp14">MUST</span> already be in the joined state.<a href="#section-4.1-3.3.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li id="section-4.1-3.4">
            <p id="section-4.1-3.4.1">If the event is invalid, it is rejected. Otherwise, it is forwarded by the
hub to the target user's server to give it the opportunity to reject the
invite early in the process. This is described by <a href="#op-check" class="auto internal xref">Section 6.3.2</a>.<a href="#section-4.1-3.4.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-4.1-3.5">
            <p id="section-4.1-3.5.1">If the target server rejected the event, the event is rejected by the hub as
well. Otherwise, the event is fanned out (<a href="#fanout" class="auto internal xref">Section 6.3.1.1</a>) to all participating
servers, plus the target server if not already participating.<a href="#section-4.1-3.5.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-4.1-4">At this stage, the <em>user</em> is now invited but their clients are not members of
the MLS group. The invite is delivered to the target's clients through relevant
provider-specific API where the user can then accept or decline the invite.<a href="#section-4.1-4" class="pilcrow">¶</a></p>
<p id="section-4.1-5">If the user declines the invite, they are transitioned to the leave state
described by <a href="#leaves" class="auto internal xref">Section 4.3</a>. Accepting is done by joining (<a href="#joins" class="auto internal xref">Section 4.2</a>) the room.<a href="#section-4.1-5" class="pilcrow">¶</a></p>
<span id="name-invite-happy-path"></span><div id="fig-invites">
<figure id="figure-1">
          <div id="section-4.1-6.1">
            <div class="alignLeft art-svg artwork" id="section-4.1-6.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="496" width="568" viewBox="0 0 568 496" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,32 L 8,64" fill="none" stroke="black"></path>
                <path d="M 24,72 L 24,480" fill="none" stroke="black"></path>
                <path d="M 40,32 L 40,64" fill="none" stroke="black"></path>
                <path d="M 232,112 L 232,144" fill="none" stroke="black"></path>
                <path d="M 272,32 L 272,64" fill="none" stroke="black"></path>
                <path d="M 296,72 L 296,480" fill="none" stroke="black"></path>
                <path d="M 320,32 L 320,64" fill="none" stroke="black"></path>
                <path d="M 512,240 L 512,272" fill="none" stroke="black"></path>
                <path d="M 528,32 L 528,64" fill="none" stroke="black"></path>
                <path d="M 544,72 L 544,480" fill="none" stroke="black"></path>
                <path d="M 560,32 L 560,64" fill="none" stroke="black"></path>
                <path d="M 8,32 L 40,32" fill="none" stroke="black"></path>
                <path d="M 272,32 L 320,32" fill="none" stroke="black"></path>
                <path d="M 528,32 L 560,32" fill="none" stroke="black"></path>
                <path d="M 8,64 L 40,64" fill="none" stroke="black"></path>
                <path d="M 272,64 L 320,64" fill="none" stroke="black"></path>
                <path d="M 528,64 L 560,64" fill="none" stroke="black"></path>
                <path d="M 32,112 L 232,112" fill="none" stroke="black"></path>
                <path d="M 32,144 L 232,144" fill="none" stroke="black"></path>
                <path d="M 32,192 L 288,192" fill="none" stroke="black"></path>
                <path d="M 304,240 L 512,240" fill="none" stroke="black"></path>
                <path d="M 304,272 L 512,272" fill="none" stroke="black"></path>
                <path d="M 32,320 L 288,320" fill="none" stroke="black"></path>
                <path d="M 304,368 L 536,368" fill="none" stroke="black"></path>
                <path d="M 304,416 L 536,416" fill="none" stroke="black"></path>
                <path d="M 32,464 L 288,464" fill="none" stroke="black"></path>
                <path d="M 304,464 L 536,464" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="544,464 532,458.4 532,469.6" fill="black" transform="rotate(0,536,464)"></polygon>
                <polygon class="arrowhead" points="544,368 532,362.4 532,373.6" fill="black" transform="rotate(0,536,368)"></polygon>
                <polygon class="arrowhead" points="312,416 300,410.4 300,421.6" fill="black" transform="rotate(180,304,416)"></polygon>
                <polygon class="arrowhead" points="312,272 300,266.4 300,277.6" fill="black" transform="rotate(180,304,272)"></polygon>
                <polygon class="arrowhead" points="296,192 284,186.4 284,197.6" fill="black" transform="rotate(0,288,192)"></polygon>
                <polygon class="arrowhead" points="40,464 28,458.4 28,469.6" fill="black" transform="rotate(180,32,464)"></polygon>
                <polygon class="arrowhead" points="40,320 28,314.4 28,325.6" fill="black" transform="rotate(180,32,320)"></polygon>
                <polygon class="arrowhead" points="40,144 28,138.4 28,149.6" fill="black" transform="rotate(180,32,144)"></polygon>
                <g class="text">
                  <text x="24" y="52">A</text>
                  <text x="296" y="52">Hub</text>
                  <text x="544" y="52">B</text>
                  <text x="60" y="100">Create</text>
                  <text x="136" y="100">m.room.user</text>
                  <text x="212" y="100">invite</text>
                  <text x="52" y="180">Send</text>
                  <text x="96" y="180">event</text>
                  <text x="152" y="180">request</text>
                  <text x="224" y="180">initiated</text>
                  <text x="340" y="228">Validate</text>
                  <text x="424" y="228">m.room.user</text>
                  <text x="496" y="228">event</text>
                  <text x="72" y="308">200</text>
                  <text x="100" y="308">OK</text>
                  <text x="124" y="308">to</text>
                  <text x="156" y="308">send</text>
                  <text x="200" y="308">event</text>
                  <text x="256" y="308">request</text>
                  <text x="328" y="356">Check</text>
                  <text x="376" y="356">event</text>
                  <text x="432" y="356">request</text>
                  <text x="496" y="404">200</text>
                  <text x="524" y="404">OK</text>
                  <text x="136" y="452">Async</text>
                  <text x="188" y="452">fanout</text>
                  <text x="228" y="452">of</text>
                  <text x="264" y="452">event</text>
                  <text x="328" y="452">Async</text>
                  <text x="380" y="452">fanout</text>
                  <text x="420" y="452">of</text>
                  <text x="456" y="452">event</text>
                </g>
              </svg><a href="#section-4.1-6.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-invite-happy-path" class="selfRef">Invite happy path</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="joins">
<section id="section-4.2">
        <h3 id="name-joins">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-joins" class="section-name selfRef">Joins</a>
        </h3>
<p id="section-4.2-1">A user can join a room in two ways:<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.2-2">
<li id="section-4.2-2.1">
            <p id="section-4.2-2.1.1">Using an external commit to Add themselves to the MLS group.<a href="#section-4.2-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-4.2-2.2">
            <p id="section-4.2-2.2.1">Receiving a Welcome message from a joined member of the MLS group.<a href="#section-4.2-2.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-4.2-3">In both cases, a join <code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 4.6</a>) state event is also sent.<a href="#section-4.2-3" class="pilcrow">¶</a></p>
<p id="section-4.2-4">Typically, a client will use the first option when joining a public room or
responding to an invite because the hub server can assist them in the join.
Option 2 is generally used as a form of invite, though skipping the explicit
<code>m.room.user</code> invite described by <a href="#invites" class="auto internal xref">Section 4.1</a>.<a href="#section-4.2-4" class="pilcrow">¶</a></p>
<p id="section-4.2-5">The hub server <span class="bcp14">MUST</span> allow proposals and commits to add a user's own clients if
they're in the joined participation state. Similarly, the hub server <span class="bcp14">MUST NOT</span>
allow proposals or commits to add clients which are not in the joined
participation state. These conditions permit the user to add their own clients
after joining without issue, which may involve an external commit.<a href="#section-4.2-5" class="pilcrow">¶</a></p>
<div id="join-external">
<section id="section-4.2.1">
          <h4 id="name-external-commit-flow">
<a href="#section-4.2.1" class="section-number selfRef">4.2.1. </a><a href="#name-external-commit-flow" class="section-name selfRef">External Commit Flow</a>
          </h4>
<p id="section-4.2.1-1">The joining user's server first updates the user's participation state (an
<code>m.room.user</code> state event, <a href="#ev-mroomuser" class="auto internal xref">Section 4.6</a>) and sends that to the hub
(<a href="#op-send" class="auto internal xref">Section 6.3.1</a>) for validation. If the joining user's server is the hub server, it
does the steps described in <a href="#op-send" class="auto internal xref">Section 6.3.1</a> to complete the event.<a href="#section-4.2.1-1" class="pilcrow">¶</a></p>
<p id="section-4.2.1-2">The join event is then validated by the hub as follows:<a href="#section-4.2.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2.1-3.1">
              <p id="section-4.2.1-3.1.1">The target and sending user of the event <span class="bcp14">MUST</span> be the same.<a href="#section-4.2.1-3.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.2.1-3.2">
              <p id="section-4.2.1-3.2.1">The target user <span class="bcp14">MUST NOT</span> be banned from the room.<a href="#section-4.2.1-3.2.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.2.1-4.1">
              <p id="section-4.2.1-4.1.1"><strong>TODO</strong>: Does requiring the sender and state key to be the same prohibit
the Welcome flow from working? (I don't believe so because they still need
to Add themselves?)<a href="#section-4.2.1-4.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.2.1-5.1">
              <p id="section-4.2.1-5.1.1"><strong>TODO</strong>: Incorporate public and invite-only room conditions from policy.<a href="#section-4.2.1-5.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.2.1-6">If the event is valid, it is fanned out (<a href="#fanout" class="auto internal xref">Section 6.3.1.1</a>) to all participating
servers in the room, which now includes the joining server (if not already).<a href="#section-4.2.1-6" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.2.1-7.1">
              <p id="section-4.2.1-7.1.1"><strong>TODO</strong>: It would be helpful if in response to the send request the hub
server provided information required to externally join, maybe.<a href="#section-4.2.1-7.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.2.1-8">The user's clients are then able to use external commits to join the MLS group.
This is accomplished using <a href="#op-external-join" class="auto internal xref">Section 6.3.5</a>.<a href="#section-4.2.1-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="join-welcome">
<section id="section-4.2.2">
          <h4 id="name-welcome-flow">
<a href="#section-4.2.2" class="section-number selfRef">4.2.2. </a><a href="#name-welcome-flow" class="section-name selfRef">Welcome Flow</a>
          </h4>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.2.2-1.1">
              <p id="section-4.2.2-1.1.1"><strong>TODO</strong>: Is this better phrased as an invite rather than join?<a href="#section-4.2.2-1.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.2.2-2">This flow is more similar to an invite (<a href="#invites" class="auto internal xref">Section 4.1</a>), though provides the
receiving user's clients with enough information to join without external
commit.<a href="#section-4.2.2-2" class="pilcrow">¶</a></p>
<p id="section-4.2.2-3">The inviting user's client first requests KeyPackages for all of the target
user's client through <a href="#op-claim" class="auto internal xref">Section 6.3.4</a>. The inviting client then uses the
KeyPackages to create Welcome MLS messages for the target user's clients.<a href="#section-4.2.2-3" class="pilcrow">¶</a></p>
<p id="section-4.2.2-4">The Welcome messages are sent to the hub server alongside an <code>m.room.user</code>
(<a href="#ev-mroomuser" class="auto internal xref">Section 4.6</a>) invite event using <a href="#op-send" class="auto internal xref">Section 6.3.1</a>. If the inviting user's server
is the hub server for the room, it completes the event using the steps described
by <a href="#op-send" class="auto internal xref">Section 6.3.1</a> instead. The event is validated according to <a href="#invites" class="auto internal xref">Section 4.1</a> and
fanned out (<a href="#fanout" class="auto internal xref">Section 6.3.1.1</a>) to all participating servers, plus the target user's
server. The target user's server also receives the Welcome messages to deliver
to the relevant clients.<a href="#section-4.2.2-4" class="pilcrow">¶</a></p>
<p id="section-4.2.2-5">The user can then join the room by sending an <code>m.room.user</code> join event. The
process and applied validation are the same as <a href="#join-external" class="auto internal xref">Section 4.2.1</a>. The user's
clients can then Add themselves to the MLS group using the Welcome messages they
received earlier. If the Welcome messages are no longer valid, the clients can
use external commits instead.<a href="#section-4.2.2-5" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.2.2-6.1">
              <p id="section-4.2.2-6.1.1"><strong>TODO</strong>: Should we permit the join event to be accompanied by the client's
Add commits?<a href="#section-4.2.2-6.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.2.2-7.1">
              <p id="section-4.2.2-7.1.1"><strong>TODO</strong>: Is this Welcome flow correct, specifically the handling of Welcome
MLS messages?<a href="#section-4.2.2-7.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</section>
</div>
</section>
</div>
<div id="leaves">
<section id="section-4.3">
        <h3 id="name-leaves-kicks">
<a href="#section-4.3" class="section-number selfRef">4.3. </a><a href="#name-leaves-kicks" class="section-name selfRef">Leaves/Kicks</a>
        </h3>
<p id="section-4.3-1">Leaving a room can signal a user declining an invite, voluntarily leaving the
room, or being kicked (removed) from the room. When the sender and target of
an <code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 4.6</a>) leave event are different, the target user
is being kicked. Otherwise the event represents a voluntary leave or declined
invite (if the previous participation state was "invited").<a href="#section-4.3-1" class="pilcrow">¶</a></p>
<p id="section-4.3-2">Like with other participation/membership operations, a user's leave is initiated
by updating their participation state first. This is done by sending
(<a href="#op-send" class="auto internal xref">Section 6.3.1</a>) the relevant <code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 4.6</a>) state event to the
hub, which validates it as follows:<a href="#section-4.3-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.3-3.1">
            <p id="section-4.3-3.1.1">If the target and sender are the same, the user <span class="bcp14">MUST</span> be in the invited,
joined, or knocking participation state.<a href="#section-4.3-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.3-3.2">
            <p id="section-4.3-3.2.1">Otherwise:<a href="#section-4.3-3.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.3-3.2.2.1">
                <p id="section-4.3-3.2.2.1.1">The target user of the kick <span class="bcp14">MUST</span> be in the joined participation state.<a href="#section-4.3-3.2.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.3-3.2.2.2">
                <p id="section-4.3-3.2.2.2.1">The sender for a kick <span class="bcp14">MUST</span> be in the joined participation state.<a href="#section-4.3-3.2.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.3-4.1">
            <p id="section-4.3-4.1.1"><strong>TODO</strong>: Include special case permissions constraints.<a href="#section-4.3-4.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-4.3-5">If the event is valid, it is fanned out (<a href="#fanout" class="auto internal xref">Section 6.3.1.1</a>) to all particpating
servers, plus the target user's server.<a href="#section-4.3-5" class="pilcrow">¶</a></p>
<p id="section-4.3-6">The next commit in the MLS group <span class="bcp14">MUST</span> remove <em>all</em> of the target user's clients.
If there are multiple users in the leave participation state, all of their
clients <span class="bcp14">MUST</span> be removed in the same commit. Other proposals <span class="bcp14">MAY</span> be committed
alongside the removals, however the commit <span class="bcp14">MUST</span> at a minimum remove the affected
clients.<a href="#section-4.3-6" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.3-7.1">
            <p id="section-4.3-7.1.1"><strong>TODO</strong>: Describe how hub server generates proposals? Or do we just require
some member in the group to do it? See also: Section 3.5 of
<span>[<a href="#I-D.robert-mimi-delivery-service" class="cite xref">I-D.robert-mimi-delivery-service</a>]</span>.<a href="#section-4.3-7.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-4.3-8">Prior to a voluntary <code>m.room.user</code> leave event, the sender <span class="bcp14">SHOULD</span> send proposals
to remove their own clients from the MLS group. Where possible, those clients
<span class="bcp14">SHOULD</span> commit their removal prior to updating their participation state as well.<a href="#section-4.3-8" class="pilcrow">¶</a></p>
<p id="section-4.3-9">Clients can propose to remove themselves from the MLS group at any time. The hub
server <span class="bcp14">MUST</span> allow commits at any time to honor those proposals. The hub server
<span class="bcp14">MUST NOT</span> allow a commit which contains an inline proposal to remove another
client, unless that client belongs to a user in the leave participation state.<a href="#section-4.3-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="bans">
<section id="section-4.4">
        <h3 id="name-bans">
<a href="#section-4.4" class="section-number selfRef">4.4. </a><a href="#name-bans" class="section-name selfRef">Bans</a>
        </h3>
<p id="section-4.4-1">Bans imply kick, and are operated the same way as <a href="#leaves" class="auto internal xref">Section 4.3</a>, though with the
<code>m.room.user</code> (<a href="#ev-mroomuser" class="auto internal xref">Section 4.6</a>) state event using a <code>ban</code> participation state.<a href="#section-4.4-1" class="pilcrow">¶</a></p>
<p id="section-4.4-2">An added exception on the validation is also applied to permit preemptive bans:
the target user is not required to be in the joined state to allow the
participation state change.<a href="#section-4.4-2" class="pilcrow">¶</a></p>
<p id="section-4.4-3">Unbans can be performed by transitioning a user from the banned participation
state to leave with <a href="#leaves" class="auto internal xref">Section 4.3</a>.<a href="#section-4.4-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="knocks">
<section id="section-4.5">
        <h3 id="name-knocks">
<a href="#section-4.5" class="section-number selfRef">4.5. </a><a href="#name-knocks" class="section-name selfRef">Knocks</a>
        </h3>
<p id="section-4.5-1">In this state, the sender of a knock is requesting an invite (<a href="#invites" class="auto internal xref">Section 4.1</a>) to
the room. They do not have access to the MLS group.<a href="#section-4.5-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.5-2.1">
            <p id="section-4.5-2.1.1"><strong>TODO</strong>: Discuss if this participation state is desirable, and figure out
details for how it works. It'd likely just be an <code>m.room.user</code> state event
with no MLS interaction, like invites are.<a href="#section-4.5-2.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="ev-mroomuser">
<section id="section-4.6">
        <h3 id="name-mroomuser">
<a href="#section-4.6" class="section-number selfRef">4.6. </a><a href="#name-mroomuser" class="section-name selfRef"><code>m.room.user</code></a>
        </h3>
<p id="section-4.6-1"><strong>Event type</strong>: <code>m.room.user</code><a href="#section-4.6-1" class="pilcrow">¶</a></p>
<p id="section-4.6-2"><strong>State key</strong>: ID of target user.<a href="#section-4.6-2" class="pilcrow">¶</a></p>
<p id="section-4.6-3"><strong>Additional event fields</strong>:<a href="#section-4.6-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.6-4">
<pre>
struct {
   // The new participation state for the target user.
   ParticipationState state;

   // Optional human-readable reason for the change. Typically most
   // useful on bans and knocks.
   opaque [[reason]];
} UserEvent;
</pre><a href="#section-4.6-4" class="pilcrow">¶</a>
</div>
<p id="section-4.6-5"><strong>Additional authentication rules</strong>:<a href="#section-4.6-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6-6.1">
            <p id="section-4.6-6.1.1">The event's <code>authEventIds</code> <span class="bcp14">MUST</span> include a reference to the sender's
most recent <code>m.room.user</code> event, if one exists, and the room's <code>m.room.create</code>
event.<a href="#section-4.6-6.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.6-6.2">
            <p id="section-4.6-6.2.1">Rules described by <a href="#invites" class="auto internal xref">Section 4.1</a>, <a href="#joins" class="auto internal xref">Section 4.2</a>, <a href="#leaves" class="auto internal xref">Section 4.3</a>, <a href="#bans" class="auto internal xref">Section 4.4</a>, <a href="#knocks" class="auto internal xref">Section 4.5</a>.<a href="#section-4.6-6.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.6-7.1">
            <p id="section-4.6-7.1.1"><strong>TODO</strong>: Include auth rules for permissions.<a href="#section-4.6-7.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.6-8.1">
            <p id="section-4.6-8.1.1"><strong>TODO</strong>: Somehow link the event to a client identity? (or several clients)
See also: Section 3.8 of <span>[<a href="#I-D.robert-mimi-delivery-service" class="cite xref">I-D.robert-mimi-delivery-service</a>]</span>.<a href="#section-4.6-8.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="application-messages">
<section id="section-5">
      <h2 id="name-application-messages">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-application-messages" class="section-name selfRef">Application Messages</a>
      </h2>
<p id="section-5-1">Clients engage in messaging through use of a content format
(<span>[<a href="#I-D.ietf-mimi-content" class="cite xref">I-D.ietf-mimi-content</a>]</span>) and MLS Application Messages. The resulting
<code>PrivateMessage</code> is carried in an <code>m.room.encrypted</code> (<a href="#ev-mroomencrypted" class="auto internal xref">Section 5.1</a>)
event.<a href="#section-5-1" class="pilcrow">¶</a></p>
<p id="section-5-2">The client's server sends the event to the hub with <a href="#op-send" class="auto internal xref">Section 6.3.1</a>. If the client's
server is the room's hub server, it completes the events with the steps
described by <a href="#op-send" class="auto internal xref">Section 6.3.1</a> instead. The event is then fanned out (<a href="#fanout" class="auto internal xref">Section 6.3.1.1</a>) by
the hub to all participating servers in the room, including the sender's.<a href="#section-5-2" class="pilcrow">¶</a></p>
<p id="section-5-3">How the event goes from client to server, and server to client, is out of scope
for this document.<a href="#section-5-3" class="pilcrow">¶</a></p>
<div id="ev-mroomencrypted">
<section id="section-5.1">
        <h3 id="name-mroomencrypted">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-mroomencrypted" class="section-name selfRef"><code>m.room.encrypted</code></a>
        </h3>
<p id="section-5.1-1"><strong>Event type</strong>: <code>m.room.encrypted</code><a href="#section-5.1-1" class="pilcrow">¶</a></p>
<p id="section-5.1-2"><strong>State key</strong>: Not present.<a href="#section-5.1-2" class="pilcrow">¶</a></p>
<p id="section-5.1-3"><strong>Additional event fields</strong>:<a href="#section-5.1-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.1-4">
<pre>
struct {
   // The PrivateMessage
   MLSMessage message;
} EncryptedEvent;
</pre><a href="#section-5.1-4" class="pilcrow">¶</a>
</div>
<p id="section-5.1-5"><strong>Additional authentication rules</strong>:<a href="#section-5.1-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.1-6.1">
            <p id="section-5.1-6.1.1"><code>message</code> <span class="bcp14">MUST</span> be an MLS PrivateMessage.<a href="#section-5.1-6.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="transport">
<section id="section-6">
      <h2 id="name-transport">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-transport" class="section-name selfRef">Transport</a>
      </h2>
<p id="section-6-1">Servers communicate with each other over HTTP <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>. Endpoints have the
protocol version embedded into the path for simplified routing between physical
servers.<a href="#section-6-1" class="pilcrow">¶</a></p>
<div id="authentication">
<section id="section-6.1">
        <h3 id="name-authentication-2">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-authentication-2" class="section-name selfRef">Authentication</a>
        </h3>
<p id="section-6.1-1">All endpoints, with the exception of <code>.well-known</code> endpoints use the mutually
authenticated mode of TLS <span>[<a href="#RFC5246" class="cite xref">RFC5246</a>]</span>. This provides guarantees that each
server is speaking to an expected party.<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.1-2.1">
            <p id="section-6.1-2.1.1"><strong>TODO</strong>: More information specific to how TLS should be used, i.e. mandate
best practices that make sense in a mutually authenticated scenario that
involves two WebPKI based certificates.<a href="#section-6.1-2.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-6.1-3">Individual events may transit between multiple servers. TLS provides
point-to-point security properties while <a href="#event-auth" class="auto internal xref">Section 3.2</a> provides event security
guarantees when transiting over multiple servers.<a href="#section-6.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="endpoint-discovery">
<section id="section-6.2">
        <h3 id="name-endpoint-discovery">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-endpoint-discovery" class="section-name selfRef">Endpoint Discovery</a>
        </h3>
<p id="section-6.2-1">A messaging provider that wants to query the endpoint of another messaging
provider first has to discover the fully qualified domain name it can use to
communicate with that provider. It does so by performing a GET request to
<code>https://example.org/.well-known/mimi/domain</code>. example.org could, for example,
answer by providing the domain <code>mimi.example.org</code> (assuming that this is where
it responds to the REST endpoints defined in <a href="#rest-api" class="auto internal xref">Section 6.3</a>).<a href="#section-6.2-1" class="pilcrow">¶</a></p>
<p id="section-6.2-2">The expected response format is simply a <code>text/plain</code> body containing the fully
qualified domain name.<a href="#section-6.2-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.2-3">
<pre>
GET https://example.org/.well-known/mimi/domain

Response
mimi.example.org
</pre><a href="#section-6.2-3" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="rest-api">
<section id="section-6.3">
        <h3 id="name-rest-endpoints">
<a href="#section-6.3" class="section-number selfRef">6.3. </a><a href="#name-rest-endpoints" class="section-name selfRef">REST Endpoints</a>
        </h3>
<p id="section-6.3-1">The following REST endpoints can be used to communicate with a MIMI server.<a href="#section-6.3-1" class="pilcrow">¶</a></p>
<p id="section-6.3-2">All operations rely on TLS-encoded structs and therefore requests and responses
<span class="bcp14">SHOULD</span> use a <code>Content-Type</code> of <code>application/octet-stream</code>.<a href="#section-6.3-2" class="pilcrow">¶</a></p>
<div id="op-send">
<section id="section-6.3.1">
          <h4 id="name-send-event">
<a href="#section-6.3.1" class="section-number selfRef">6.3.1. </a><a href="#name-send-event" class="section-name selfRef">Send Event</a>
          </h4>
<p id="section-6.3.1-1">Asks the server to send an event (<a href="#event-schema" class="auto internal xref">Section 3.1</a>). Events can take two shapes
over this endpoint, depending on whether a follower or hub server is doing the
sending.<a href="#section-6.3.1-1" class="pilcrow">¶</a></p>
<p id="section-6.3.1-2">When a follower server is sending an event, it <span class="bcp14">MUST</span> only be attempting to send
to the hub server for the room. Follower servers receiving an event from another
follower server <span class="bcp14">MUST</span> reject the request with a <code>400</code> HTTP status code. The hub
server <span class="bcp14">MUST</span> populate the <code>authEventIds</code> and <code>prevEventId</code> fields of the event,
validate the resulting event, then reply with a <code>200</code> HTTP status code and the
resulting event ID (<a href="#reference-hash" class="auto internal xref">Section 3.2.1</a>). The resulting event is then fanned out
<a href="#fanout" class="auto internal xref">Section 6.3.1.1</a> to relevant servers in the room.<a href="#section-6.3.1-2" class="pilcrow">¶</a></p>
<p id="section-6.3.1-3">The hub server <span class="bcp14">MUST</span> validate events according to <a href="#event-auth" class="auto internal xref">Section 3.2</a> and any event
type-specific validation rules. If the event is malformed in any way, or the
room is unknown, the server <span class="bcp14">MUST</span> respond with a <code>400</code> HTTP status code.<a href="#section-6.3.1-3" class="pilcrow">¶</a></p>
<p id="section-6.3.1-4">Follower servers <span class="bcp14">SHOULD</span> apply the same validation as hub servers upon receiving
a send request to identify potentially malicious hub servers.<a href="#section-6.3.1-4" class="pilcrow">¶</a></p>
<p id="section-6.3.1-5">Follower servers sending an event to the hub server will not include
<code>authEventIds</code> or <code>prevEventId</code> because they are populated by the hub server.
Hub servers <span class="bcp14">MUST</span> employ locking to ensure each event has exactly one child
implied by <code>prevEventId</code>. This locking mechanism <span class="bcp14">MAY</span> cause another request to be
rejected because the room state was mutated. For example, if the hub receives
a ban event in one request and a message from the to-be-banned user in another,
the message may be rejected if the ban is processed first. Hub servers <span class="bcp14">SHOULD</span>
process requests in the order they were received.<a href="#section-6.3.1-5" class="pilcrow">¶</a></p>
<p id="section-6.3.1-6">If an event is rejected during processing, the event <span class="bcp14">MUST NOT</span> be fanned out.<a href="#section-6.3.1-6" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3.1-7">
<pre>
struct {
   // The resulting event ID that is about to be fanned out by the hub server.
   // Not included if the called server is a follower server.
   opaque [[eventId]];
} SendEndpointResponse;
</pre><a href="#section-6.3.1-7" class="pilcrow">¶</a>
</div>
<div class="alignLeft art-text artwork" id="section-6.3.1-8">
<pre>
POST /v1/send
Content-Type: application/octet-stream

Body
TLS-serialized Event (including additional fields, such as CreateEvent)

Response
TLS-serialized SendEndpointResponse
</pre><a href="#section-6.3.1-8" class="pilcrow">¶</a>
</div>
<p id="section-6.3.1-9">Servers <span class="bcp14">SHOULD</span> retry this request with exponential backoff (to a limit) if they
receive timeout/network errors.<a href="#section-6.3.1-9" class="pilcrow">¶</a></p>
<div id="fanout">
<section id="section-6.3.1.1">
            <h5 id="name-fanout">
<a href="#section-6.3.1.1" class="section-number selfRef">6.3.1.1. </a><a href="#name-fanout" class="section-name selfRef">Fanout</a>
            </h5>
<p id="section-6.3.1.1-1">A hub server fans an event out by using the send endpoint described above on all
participating servers in the room. A server is considered "participating" if it
has at least one user in the joined participation state, described by
<a href="#membership" class="auto internal xref">Section 4</a>.<a href="#section-6.3.1.1-1" class="pilcrow">¶</a></p>
<p id="section-6.3.1.1-2">Additional servers <span class="bcp14">MAY</span> have the event sent to them if required by the steps
leading up to fanout.<a href="#section-6.3.1.1-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="op-check">
<section id="section-6.3.2">
          <h4 id="name-check-invite-event">
<a href="#section-6.3.2" class="section-number selfRef">6.3.2. </a><a href="#name-check-invite-event" class="section-name selfRef">Check Invite Event</a>
          </h4>
<p id="section-6.3.2-1">Used by the hub server to ensure a follower server can (and is willing to)
process an incoming invite. The called server <span class="bcp14">MAY</span> use this opportunity to ensure
the inviting user has general consent to invite the target user. For example,
ensuring the invite does not appear spammy in nature and if the inviter already
has a connection with the invitee.<a href="#section-6.3.2-1" class="pilcrow">¶</a></p>
<p id="section-6.3.2-2">If the server does not recognize the event format of the <code>m.room.create</code>
(<a href="#ev-mroomcreate" class="auto internal xref">Section 3.3.1</a>) event, or does not understand the policy/encryption
configuration contained within, it <span class="bcp14">MUST</span> reject the request.<a href="#section-6.3.2-2" class="pilcrow">¶</a></p>
<p id="section-6.3.2-3">The request <span class="bcp14">MAY</span> be rejected with a <code>400</code> HTTP status code. If everything looks
OK to the server, it responds with a <code>200</code> HTTP status code.<a href="#section-6.3.2-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3.2-4">
<pre>
struct {
   // The `m.room.user` invite event.
   UserEvent invite;

   // The `m.room.create` event for the room.
   CreateEvent roomCreate;
} CheckInviteRequest;
</pre><a href="#section-6.3.2-4" class="pilcrow">¶</a>
</div>
<div class="alignLeft art-text artwork" id="section-6.3.2-5">
<pre>
POST /v1/check-invite
Content-Type: application/octet-stream

Body
TLS-serialized CheckInviteRequest

Response
Any meaningful information. The pass/fail is identified by the HTTP response
status code, not the response body.
</pre><a href="#section-6.3.2-5" class="pilcrow">¶</a>
</div>
<p id="section-6.3.2-6">The hub server <span class="bcp14">SHOULD</span> consider a network error as a rejection. It is expected
that the original sender will attempt to re-send the invite once the server is
reachable again.<a href="#section-6.3.2-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="op-get-event">
<section id="section-6.3.3">
          <h4 id="name-retrieve-event">
<a href="#section-6.3.3" class="section-number selfRef">6.3.3. </a><a href="#name-retrieve-event" class="section-name selfRef">Retrieve Event</a>
          </h4>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.3.3-1.1">
              <p id="section-6.3.3-1.1.1"><strong>TODO</strong>: What specific APIs does a follower server need to operate? Some
options include:<a href="#section-6.3.3-1.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.3.3-1.1.2.1">
                  <p id="section-6.3.3-1.1.2.1.1"><code>GET /v1/event/:eventId</code><a href="#section-6.3.3-1.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-6.3.3-1.1.2.2">
                  <p id="section-6.3.3-1.1.2.2.1"><code>GET /v1/room/:roomId/state</code> (current room state events)<a href="#section-6.3.3-1.1.2.2.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-6.3.3-1.1.2.3">
                  <p id="section-6.3.3-1.1.2.3.1"><code>GET /v1/room/:roomId/state/:eventType/:stateKey</code><a href="#section-6.3.3-1.1.2.3.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-6.3.3-1.1.2.4">
                  <p id="section-6.3.3-1.1.2.4.1"><code>GET /v1/event/:eventId/child</code><a href="#section-6.3.3-1.1.2.4.1" class="pilcrow">¶</a></p>
</li>
              </ul>
</li>
          </ul>
</section>
</div>
<div id="op-claim">
<section id="section-6.3.4">
          <h4 id="name-retrieve-keypackages">
<a href="#section-6.3.4" class="section-number selfRef">6.3.4. </a><a href="#name-retrieve-keypackages" class="section-name selfRef">Retrieve KeyPackages</a>
          </h4>
<p id="section-6.3.4-1">Asks the server for KeyPackages belonging to a user's clients. Like with
<a href="#op-check" class="auto internal xref">Section 6.3.2</a>, if the requesting user does not have general consent to invite the
target user, the request is rejected.<a href="#section-6.3.4-1" class="pilcrow">¶</a></p>
<p id="section-6.3.4-2">To ensure requests do not fail while clients are offline or otherwise
unreachable, KeyPackages <span class="bcp14">SHOULD</span> be uploaded by the generating client to their
local server for later usage.<a href="#section-6.3.4-2" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.3.4-3.1">
              <p id="section-6.3.4-3.1.1"><strong>TODO</strong>: Mark KeyPackages of last resort somehow.<a href="#section-6.3.4-3.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-6.3.4-4">This request is always sent to the hub server which then proxies the request
directly to the relevant follower server.<a href="#section-6.3.4-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3.4-5">
<pre>
struct {
   // The user ID to retrieve KeyPackages for. This will download 1 KeyPackage
   // for each of the user's clients.
   opaque userId;

   // The user ID requesting the KeyPackages for `userId`.
   opaque requestingUserId;

   // The room (group) ID where the KeyPackages are valid for.
   opaque roomId;
} GetKeyPackagesRequest;

struct {
   // One KeyPackage for each of the requested user's clients.
   KeyPackage keyPackages&lt;V&gt;;
} GetKeyPackagesResponse;
</pre><a href="#section-6.3.4-5" class="pilcrow">¶</a>
</div>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.3.4-6.1">
              <p id="section-6.3.4-6.1.1"><strong>TODO</strong>: Do we need to sign or otherwise guarantee security on the
<code>requestingUserId</code>? We do for invite events, so why not here?<a href="#section-6.3.4-6.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<div class="alignLeft art-text artwork" id="section-6.3.4-7">
<pre>
POST /v1/key_packages
Content-Type: application/octet-stream

Body
TLS-serialized GetKeyPackagesRequest

Response
TLS-serialized GetKeyPackagesResponse
</pre><a href="#section-6.3.4-7" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="op-external-join">
<section id="section-6.3.5">
          <h4 id="name-external-group-join">
<a href="#section-6.3.5" class="section-number selfRef">6.3.5. </a><a href="#name-external-group-join" class="section-name selfRef">External Group Join</a>
          </h4>
<p id="section-6.3.5-1">When a client wishes to perform an external join to the MLS group, it may
require assistance from the hub server in order to be successful. This endpoint
is used by a follower server on a client's behalf to complete the external join.<a href="#section-6.3.5-1" class="pilcrow">¶</a></p>
<p id="section-6.3.5-2">The hub server is able to provide this service to the requester because it keeps
track of the information required to generate a GroupInfo object. The requester
is still required to supply a <code>Signature</code> and relevant GroupInfo extensions,
which are required to complete the GroupInfo object.<a href="#section-6.3.5-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3.5-3">
<pre>
struct {
   Extension group_info_extensions&lt;V&gt;;
   opaque Signature&lt;V&gt;;
} PartialGroupInfo;

struct {
   MLSMessage commit;
   PartialGroupInfo partial_group_info;
} MLSGroupUpdate;
</pre><a href="#section-6.3.5-3" class="pilcrow">¶</a>
</div>
<p id="section-6.3.5-4">The MLSMessage <span class="bcp14">MUST</span> contain a PublicMessage which contains a commit with sender
type NewMemberCommit.<a href="#section-6.3.5-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3.5-5">
<pre>
POST /v1/external_join
Content-Type: application/octet-stream

Body
TLS-serialized MLSGroupUpdate

Response
Any meaningful information. The pass/fail is identified by the HTTP response
status code, not the response body.
</pre><a href="#section-6.3.5-5" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="op-mls-add">
<section id="section-6.3.6">
          <h4 id="name-add-remove-and-update-mls-g">
<a href="#section-6.3.6" class="section-number selfRef">6.3.6. </a><a href="#name-add-remove-and-update-mls-g" class="section-name selfRef">Add, Remove, and Update MLS Group Clients</a>
          </h4>
<p id="section-6.3.6-1">As described by <a href="#joins" class="auto internal xref">Section 4.2</a>, users which are joined participants are able to add
their clients at any time to the MLS group. Clients which do not belong to a
joined user <span class="bcp14">MUST</span> be rejected from joining the group. Similarly, clients may
elect to leave the MLS group at any time, as per <a href="#leaves" class="auto internal xref">Section 4.3</a>.<a href="#section-6.3.6-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3.6-2">
<pre>
struct {
   // MUST be a PublicMessage with a commit that only contains Add proposals
   // for a joined user's clients.
   //
   // MUST NOT change the sending client's credential.
   MLSGroupUpdate group_update;
   MLSMessage welcome_messages&lt;V&gt;;
} AddClientsRequest;

struct {
   // MUST NOT change the sending client's credential.
   MLSGroupUpdate group_update;
} RemoveClientsRequest;

struct {
   // MUST contain a PublicMessage which contains a commit with an UpdatePath,
   // but not other proposals by value.
   MLSGroupUpdate group_update;
} UpdateClientRequest;

enum {
   add,
   remove,
   update,
} MLSOperation;

struct {
   MLSOperation operation;

   select (GroupUpdateRequest.operation) {
      case add:
         AddClientsRequest request;
      case remove:
         RemoveClientsRequest request;
      case update:
         UpdateClientRequest request;
   }
} GroupUpdateRequest;
</pre><a href="#section-6.3.6-2" class="pilcrow">¶</a>
</div>
<p id="section-6.3.6-3">The group update contained within <code>RemoveClientsRequest</code> is additionally subject
to the requirements of <a href="#leaves" class="auto internal xref">Section 4.3</a>.<a href="#section-6.3.6-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3.6-4">
<pre>
POST /v1/group_update
Content-Type: application/octet-stream

Body
TLS-serialized GroupUpdateRequest

Response
Any meaningful information. The pass/fail is identified by the HTTP response
status code, not the response body.
</pre><a href="#section-6.3.6-4" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="security-considerations">
<section id="section-7">
      <h2 id="name-security-considerations">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-7-1">Overall, the user participation state leads any possible MLS group state to
ensure malicious clients are not able to easily get access to messages.<a href="#section-7-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-7-2.1">
          <p id="section-7-2.1.1"><strong>TODO</strong>: Other security guarantees? Consensus may be required here.<a href="#section-7-2.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="iana-considerations">
<section id="section-8">
      <h2 id="name-iana-considerations">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-8-1">IANA has created the following registries:<a href="#section-8-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8-2.1">
          <p id="section-8-2.1.1">MIMI Event Types<a href="#section-8-2.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<div id="mimi-event-types">
<section id="section-8.1">
        <h3 id="name-mimi-event-types">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-mimi-event-types" class="section-name selfRef">MIMI Event Types</a>
        </h3>
<p id="section-8.1-1">An event type denotes the nature of a payload contained in an event, in the
context of the MIMI protocol. The event type is a string composed of substrings
separated by dots.<a href="#section-8.1-1" class="pilcrow">¶</a></p>
<p id="section-8.1-2">The first substring is "m", followed by the logical container being affected
(typically just "room"), then a number of descriptor strings.<a href="#section-8.1-2" class="pilcrow">¶</a></p>
<p id="section-8.1-3">Example: <code>m.room.create</code><a href="#section-8.1-3" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-8.1-4.1">
            <p id="section-8.1-4.1.1"><strong>TODO</strong>: Does IANA need any other information for legal event types?<a href="#section-8.1-4.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
</section>
</div>
<section id="section-9">
      <h2 id="name-references">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<div id="sec-normative-references">
<section id="section-9.1">
        <h3 id="name-normative-references">
<a href="#section-9.1" class="section-number selfRef">9.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="I-D.barnes-mimi-arch">[I-D.barnes-mimi-arch]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refTitle">"An Architecture for More Instant Messaging Interoperability (MIMI)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-barnes-mimi-arch-02</span>, <time datetime="2023-10-23" class="refDate">23 October 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-barnes-mimi-arch-02">https://datatracker.ietf.org/doc/html/draft-barnes-mimi-arch-02</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5246">[RFC5246]</dt>
        <dd>
<span class="refAuthor">Dierks, T.</span> and <span class="refAuthor">E. Rescorla</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.2"</span>, <span class="seriesInfo">RFC 5246</span>, <span class="seriesInfo">DOI 10.17487/RFC5246</span>, <time datetime="2008-08" class="refDate">August 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc5246">https://www.rfc-editor.org/rfc/rfc5246</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6234">[RFC6234]</dt>
        <dd>
<span class="refAuthor">Eastlake 3rd, D.</span> and <span class="refAuthor">T. Hansen</span>, <span class="refTitle">"US Secure Hash Algorithms (SHA and SHA-based HMAC and HKDF)"</span>, <span class="seriesInfo">RFC 6234</span>, <span class="seriesInfo">DOI 10.17487/RFC6234</span>, <time datetime="2011-05" class="refDate">May 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc6234">https://www.rfc-editor.org/rfc/rfc6234</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9110">[RFC9110]</dt>
        <dd>
<span class="refAuthor">Fielding, R., Ed.</span>, <span class="refAuthor">Nottingham, M., Ed.</span>, and <span class="refAuthor">J. Reschke, Ed.</span>, <span class="refTitle">"HTTP Semantics"</span>, <span class="seriesInfo">STD 97</span>, <span class="seriesInfo">RFC 9110</span>, <span class="seriesInfo">DOI 10.17487/RFC9110</span>, <time datetime="2022-06" class="refDate">June 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9110">https://www.rfc-editor.org/rfc/rfc9110</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9420">[RFC9420]</dt>
      <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Beurdouche, B.</span>, <span class="refAuthor">Robert, R.</span>, <span class="refAuthor">Millican, J.</span>, <span class="refAuthor">Omara, E.</span>, and <span class="refAuthor">K. Cohn-Gordon</span>, <span class="refTitle">"The Messaging Layer Security (MLS) Protocol"</span>, <span class="seriesInfo">RFC 9420</span>, <span class="seriesInfo">DOI 10.17487/RFC9420</span>, <time datetime="2023-07" class="refDate">July 2023</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9420">https://www.rfc-editor.org/rfc/rfc9420</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
<div id="sec-informative-references">
<section id="section-9.2">
        <h3 id="name-informative-references">
<a href="#section-9.2" class="section-number selfRef">9.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="I-D.ietf-mimi-content">[I-D.ietf-mimi-content]</dt>
        <dd>
<span class="refAuthor">Mahy, R.</span>, <span class="refTitle">"More Instant Messaging Interoperability (MIMI) message content"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-mimi-content-01</span>, <time datetime="2023-10-23" class="refDate">23 October 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-mimi-content-01">https://datatracker.ietf.org/doc/html/draft-ietf-mimi-content-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.kohbrok-mimi-transport">[I-D.kohbrok-mimi-transport]</dt>
        <dd>
<span class="refAuthor">Kohbrok, K.</span> and <span class="refAuthor">R. Robert</span>, <span class="refTitle">"MIMI Transport"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-kohbrok-mimi-transport-01</span>, <time datetime="2023-09-21" class="refDate">21 September 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-kohbrok-mimi-transport-01">https://datatracker.ietf.org/doc/html/draft-kohbrok-mimi-transport-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ralston-mimi-policy">[I-D.ralston-mimi-policy]</dt>
        <dd>
<span class="refAuthor">Ralston, T.</span> and <span class="refAuthor">M. Hodgson</span>, <span class="refTitle">"MIMI Policy Envelope"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ralston-mimi-policy-00</span>, <time datetime="2023-09-22" class="refDate">22 September 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ralston-mimi-policy-00">https://datatracker.ietf.org/doc/html/draft-ralston-mimi-policy-00</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ralston-mimi-signaling">[I-D.ralston-mimi-signaling]</dt>
        <dd>
<span class="refAuthor">Ralston, T.</span> and <span class="refAuthor">M. Hodgson</span>, <span class="refTitle">"MIMI Signaling Protocol"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ralston-mimi-signaling-00</span>, <time datetime="2023-09-22" class="refDate">22 September 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ralston-mimi-signaling-00">https://datatracker.ietf.org/doc/html/draft-ralston-mimi-signaling-00</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.robert-mimi-delivery-service">[I-D.robert-mimi-delivery-service]</dt>
        <dd>
<span class="refAuthor">Robert, R.</span> and <span class="refAuthor">K. Kohbrok</span>, <span class="refTitle">"MIMI Delivery Service"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-robert-mimi-delivery-service-05</span>, <time datetime="2023-10-23" class="refDate">23 October 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-robert-mimi-delivery-service-05">https://datatracker.ietf.org/doc/html/draft-robert-mimi-delivery-service-05</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
      <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
</section>
<div id="acknowledgments">
<section id="appendix-A">
      <h2 id="name-acknowledgments">
<a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="appendix-A-1">This document is the consolidation of the following documents:<a href="#appendix-A-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-2.1">
          <p id="appendix-A-2.1.1"><span>[<a href="#I-D.kohbrok-mimi-transport" class="cite xref">I-D.kohbrok-mimi-transport</a>]</span> forms the majority of <a href="#transport" class="auto internal xref">Section 6</a>.<a href="#appendix-A-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="appendix-A-2.2">
          <p id="appendix-A-2.2.1"><span>[<a href="#I-D.robert-mimi-delivery-service" class="cite xref">I-D.robert-mimi-delivery-service</a>]</span> describes details for <a href="#membership" class="auto internal xref">Section 4</a>,
subsections of <a href="#rest-api" class="auto internal xref">Section 6.3</a> (per transport draft), <a href="#reinit" class="auto internal xref">Section 3.5</a>, and
considerations for <a href="#ev-mroomencrypted" class="auto internal xref">Section 5.1</a>.<a href="#appendix-A-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="appendix-A-2.3">
          <p id="appendix-A-2.3.1"><span>[<a href="#I-D.ralston-mimi-signaling" class="cite xref">I-D.ralston-mimi-signaling</a>]</span> describes <a href="#event-schema" class="auto internal xref">Section 3.1</a>, <a href="#event-auth" class="auto internal xref">Section 3.2</a>,
<a href="#room-creation" class="auto internal xref">Section 3.3</a>, details of <a href="#membership" class="auto internal xref">Section 4</a>, and subsections of <a href="#rest-api" class="auto internal xref">Section 6.3</a>.<a href="#appendix-A-2.3.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="appendix-A-3">Aspects of <span>[<a href="#I-D.ralston-mimi-policy" class="cite xref">I-D.ralston-mimi-policy</a>]</span> are additionally taken into
consideration in this document through subsections of <a href="#membership" class="auto internal xref">Section 4</a>, but is
largely unincorporated and may require updates to match this document's
specifics.<a href="#appendix-A-3" class="pilcrow">¶</a></p>
<p id="appendix-A-4"><span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span> was additionally used throughout the writing
of this document.<a href="#appendix-A-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-B">
      <h2 id="name-authors-address">
<a href="#name-authors-address" class="section-name selfRef">Author's Address</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Travis Ralston (<span class="role">editor</span>)</span></div>
<div dir="auto" class="left"><span class="org">The Matrix.org Foundation C.I.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:travisr@matrix.org" class="email">travisr@matrix.org</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
